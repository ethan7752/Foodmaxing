const addWaterBtn = document.getElementById("addWaterBtn");
const mealPhotoInput = document.getElementById("mealPhotoInput");

// Add water button increments daily water
addWaterBtn.addEventListener("click", () => {
  let val = parseInt(waterInput.value, 10);
  if (isNaN(val) || val <= 0) {
    alert("Enter a positive number of ml to add.");
    return;
  }
  dailyWater += val;
  saveWater(dailyWater);
  waterInput.value = 0;
  updateProgress();
});

// Modify addFoodToLog to accept photo
function addFoodToLog(foodName, amountInput, portionType) {
  const foods = getAllFoods();
  const normName = normalizeName(foodName);
  if (!(normName in foods)) {
    alert("Food not found. Try adding a custom food first.");
    return false;
  }
  const macros = calculateMacros(foods[normName], amountInput, portionType);
  if (!macros) {
    alert("Invalid amount input.");
    return false;
  }

  // If photo input has a file, convert to base64 string
  const file = mealPhotoInput.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      const base64Image = e.target.result;
      dailyLog.push({
        name: foodName,
        ...macros,
        timestamp: Date.now(),
        photo: base64Image
      });
      saveLog(dailyLog);
      renderMealHistory();
      updateProgress();
      mealPhotoInput.value = ""; // reset photo input
    };
    reader.readAsDataURL(file);
  } else {
    dailyLog.push({
      name: foodName,
      ...macros,
      timestamp: Date.now(),
      photo: null
    });
    saveLog(dailyLog);
    renderMealHistory();
    updateProgress();
  }
  return true;
}

// Modify renderMealHistory to add Show Image button
function renderMealHistory() {
  mealHistoryDiv.innerHTML = "";
  if (dailyLog.length === 0) {
    mealHistoryDiv.textContent = "No meals logged yet.";
    return;
  }
  dailyLog.forEach((meal, i) => {
    const div = document.createElement("div");
    div.classList.add("list-item");

    const flexDiv = document.createElement("div");
    flexDiv.style.display = "flex";
    flexDiv.style.alignItems = "center";
    flexDiv.style.justifyContent = "space-between";

    const textDiv = document.createElement("div");
    textDiv.textContent = `${meal.name} — ${fmt(meal.calories)} kcal, ${fmt(meal.protein)}g P, ${fmt(meal.fat)}g F, ${fmt(meal.carbs)}g C, ${fmt(meal.weight)}g`;

    const btnGroup = document.createElement("div");

    if (meal.photo) {
      const showImgBtn = document.createElement("button");
      showImgBtn.textContent = "Show Image";
      showImgBtn.style.marginRight = "8px";
      showImgBtn.addEventListener("click", () => {
        showImageModal(meal.photo);
      });
      btnGroup.appendChild(showImgBtn);
    }

    const delBtn = document.createElement("button");
    delBtn.textContent = "❌";
    delBtn.title = "Remove this meal";
    delBtn.style.background = "#a94442";
    delBtn.style.width = "36px";
    delBtn.style.flexShrink = 0;
    delBtn.addEventListener("click", () => {
      dailyLog.splice(i, 1);
      saveLog(dailyLog);
      renderMealHistory();
      updateProgress();
    });

    btnGroup.appendChild(delBtn);

    flexDiv.appendChild(textDiv);
    flexDiv.appendChild(btnGroup);

    div.appendChild(flexDiv);
    mealHistoryDiv.appendChild(div);
  });
}

// Show image modal logic
function showImageModal(base64Image) {
  // Create modal background
  const modalBg = document.createElement("div");
  modalBg.style.position = "fixed";
  modalBg.style.top = "0";
  modalBg.style.left = "0";
  modalBg.style.width = "100vw";
  modalBg.style.height = "100vh";
  modalBg.style.backgroundColor = "rgba(0,0,0,0.8)";
  modalBg.style.display = "flex";
  modalBg.style.alignItems = "center";
  modalBg.style.justifyContent = "center";
  modalBg.style.zIndex = 10000;

  // Create image element
  const img = document.createElement("img");
  img.src = base64Image;
  img.style.maxWidth = "90vw";
  img.style.maxHeight = "90vh";
  img.style.border = "3px solid white";
  img.style.borderRadius = "8px";

  // Close modal on click
  modalBg.addEventListener("click", () => {
    document.body.removeChild(modalBg);
  });

  modalBg.appendChild(img);
  document.body.appendChild(modalBg);
}
