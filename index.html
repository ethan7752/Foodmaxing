<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ethan's Food Ai - Enhanced Tracker</title>
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Ethan's Food Ai" />
<link rel="apple-touch-icon" href="icon.png" />
<link rel="manifest" href="manifest.json" />

<style>
  :root {
    --bg-light: #f4f4f4;
    --text-light: #222;
    --bg-dark: #121212;
    --text-dark: #eee;
    --primary-color: #5e81ac;
    --primary-hover: #4a699f;
    --max-width: 480px;
  }
  body {
    margin: 0; padding: 1rem;
    font-family: Arial, sans-serif;
    background-color: var(--bg-dark);
    color: var(--text-dark);
    max-width: var(--max-width);
    margin-left: auto;
    margin-right: auto;
    transition: background-color 0.3s, color 0.3s;
  }
  body.light-mode {
    background-color: var(--bg-light);
    color: var(--text-light);
  }
  h1, h2 {
    text-align: center;
  }
  form, .settings, .history, .tracker, .reminder-section {
    background: #222;
    padding: 1rem;
    margin-bottom: 1rem;
    border-radius: 6px;
  }
  body.light-mode form, body.light-mode .settings, body.light-mode .history,
  body.light-mode .tracker, body.light-mode .reminder-section {
    background: #fff;
    box-shadow: 0 0 5px rgba(0,0,0,0.15);
  }
  input, select, button, textarea {
    font-size: 1rem;
    padding: 0.5rem;
    margin: 0.3rem 0;
    border-radius: 4px;
    border: none;
    width: 100%;
    box-sizing: border-box;
  }
  input, select, textarea {
    background: #333;
    color: #eee;
  }
  body.light-mode input, body.light-mode select, body.light-mode textarea {
    background: #fafafa;
    color: #222;
    border: 1px solid #ccc;
  }
  button {
    background: var(--primary-color);
    color: white;
    cursor: pointer;
    transition: background-color 0.3s;
  }
  button:hover {
    background: var(--primary-hover);
  }
  label {
    font-weight: bold;
    display: block;
    margin-top: 0.7rem;
  }
  #result {
    margin-top: 1rem;
  }
  .flex-row {
    display: flex;
    gap: 0.5rem;
    flex-wrap: wrap;
  }
  .flex-grow {
    flex: 1 1 auto;
  }
  .progress-container {
    margin: 0.5rem 0;
  }
  progress {
    width: 100%;
    height: 20px;
    border-radius: 10px;
    overflow: hidden;
    appearance: none;
  }
  progress::-webkit-progress-bar {
    background-color: #555;
    border-radius: 10px;
  }
  progress::-webkit-progress-value {
    background-color: var(--primary-color);
    border-radius: 10px;
  }
  .badge {
    background: #4caf50;
    color: white;
    padding: 0.3rem 0.6rem;
    border-radius: 12px;
    font-size: 0.9rem;
    display: inline-block;
    margin-top: 0.5rem;
  }
  .settings-btn {
    background: #999;
    color: #222;
    position: fixed;
    top: 1rem;
    right: 1rem;
    padding: 0.4rem 0.8rem;
    border-radius: 4px;
    z-index: 1000;
  }
  .settings-btn:hover {
    background: #777;
  }
  /* Responsive */
  @media (max-width: 600px) {
    body {
      padding: 0.7rem;
    }
  }
</style>
</head>
<body>

<button id="settingsToggle" class="settings-btn" title="Settings">⚙️</button>

<h1>Ethan's Food Ai - Enhanced Tracker</h1>

<!-- Food Entry Form -->
<form id="foodForm" autocomplete="off">
  <label for="foodName">Food Name (start typing to autocomplete):</label>
  <input list="foodList" id="foodName" name="foodName" placeholder="e.g. banana" required />
  <datalist id="foodList"></datalist>

  <label for="foodAmount">Amount (number + unit):</label>
  <div class="flex-row">
    <input type="number" min="0.1" step="any" id="foodAmount" name="foodAmount" placeholder="e.g. 1 or 150" required />
    <select id="foodUnit" name="foodUnit" style="max-width: 100px;">
      <option value="g">grams (g)</option>
      <option value="unit">units (pieces)</option>
      <option value="cup">cups</option>
    </select>
  </div>

  <button type="submit">Calculate & Add</button>
</form>

<div id="result"></div>

<!-- Custom Food Addition -->
<section class="settings" id="customFoodSection" style="display:none;">
  <h2>Add Custom Food</h2>
  <form id="customFoodForm">
    <label for="customName">Food Name:</label>
    <input type="text" id="customName" required />

    <label for="customCalories">Calories per 100g:</label>
    <input type="number" id="customCalories" min="0" required />

    <label for="customProtein">Protein per 100g (g):</label>
    <input type="number" id="customProtein" min="0" step="0.1" required />

    <label for="customFat">Fat per 100g (g):</label>
    <input type="number" id="customFat" min="0" step="0.1" required />

    <label for="customCarbs">Carbs per 100g (g):</label>
    <input type="number" id="customCarbs" min="0" step="0.1" required />

    <label for="customWeightPerUnit">Weight per unit (g):</label>
    <input type="number" id="customWeightPerUnit" min="0" step="1" value="100" required />

    <label for="customBloat">Bloat level (0-10):</label>
    <input type="number" id="customBloat" min="0" max="10" step="1" value="0" required />

    <button type="submit">Add Custom Food</button>
  </form>
</section>

<!-- Settings -->
<section class="settings" id="settingsSection" style="display:none;">
  <h2>Settings</h2>
  <label for="bgColorPicker">Background Color:</label>
  <input type="color" id="bgColorPicker" value="#121212" />

  <label for="darkModeToggle">Dark Mode:</label>
  <select id="darkModeToggle">
    <option value="true">On</option>
    <option value="false">Off</option>
  </select>

  <label for="calorieGoal">Calorie Goal (kcal):</label>
  <input type="number" id="calorieGoal" min="0" value="2500" />

  <label for="proteinGoal">Protein Goal (g):</label>
  <input type="number" id="proteinGoal" min="0" value="150" />

  <label for="fatGoal">Fat Goal (g):</label>
  <input type="number" id="fatGoal" min="0" value="70" />

  <label for="carbGoal">Carbs Goal (g):</label>
  <input type="number" id="carbGoal" min="0" value="300" />

  <button id="saveSettingsBtn">Save Settings</button>
</section>

<!-- Daily Tracker -->
<section class="tracker">
  <h2>Daily Tracker</h2>
  <div id="trackerTotals" style="font-size: 1.1rem; margin-bottom: 1rem;">
    Calories: 0 kcal | Protein: 0 g | Fat: 0 g | Carbs: 0 g
  </div>
  <div class="progress-container">
    <label>Calories</label>
    <progress id="calorieProgress" max="100" value="0"></progress>
    <small id="calorieProgressText"></small>
  </div>
  <div class="progress-container">
    <label>Protein</label>
    <progress id="proteinProgress" max="100" value="0"></progress>
    <small id="proteinProgressText"></small>
  </div>
  <div class="progress-container">
    <label>Fat</label>
    <progress id="fatProgress" max="100" value="0"></progress>
    <small id="fatProgressText"></small>
  </div>
  <div class="progress-container">
    <label>Carbs</label>
    <progress id="carbProgress" max="100" value="0"></progress>
    <small id="carbProgressText"></small>
  </div>
  <button id="resetTracker" style="background:#5e81ac; margin-top: 0.8rem;">Reset Daily Tracker</button>

  <div id="badges" style="margin-top: 1rem;"></div>
</section>

<!-- Meal History -->
<section class="history">
  <h2>Meal History (Today)</h2>
  <div id="mealHistory"></div>
  <button id="exportCsvBtn" style="margin-top:0.5rem;">Export Today’s Log as CSV</button>
</section>

<!-- Hydration Tracking -->
<section class="tracker" style="margin-bottom: 2rem;">
  <h2>Hydration Tracker</h2>
  <label for="waterInput">Add water intake (ml):</label>
  <input type="number" id="waterInput" min="0" step="any" placeholder="e.g. 250" />
  <button id="addWaterBtn">Add Water</button>
  <div id="waterTotal">Total water today: 0 ml</div>
</section>

<!-- Exercise Logging -->
<section class="tracker">
  <h2>Exercise Log</h2>
  <label for="exerciseName">Exercise Name:</label>
  <input type="text" id="exerciseName" placeholder="e.g. Running" />
  <label for="exerciseCalories">Calories Burned:</label>
  <input type="number" id="exerciseCalories" min="0" placeholder="e.g. 300" />
  <button id="addExerciseBtn">Add Exercise</button>
  <div id="exerciseList" style="margin-top: 0.5rem;"></div>
</section>

<!-- Reminder -->
<section class="reminder-section">
  <h2>Reminders</h2>
  <button id="startReminderBtn">Start Meal Reminders (Every 4 hours)</button>
  <button id="stopReminderBtn" disabled>Stop Reminders</button>
</section>

<!-- Macro Pie Chart -->
<section class="tracker">
  <h2>Macro Breakdown</h2>
  <canvas id="macroChart" width="400" height="200" style="max-width:100%;"></canvas>
</section>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
(() => {
  "use strict";

  // --- Food DB including custom food storage in localStorage ---
  let foodDB = {
    banana: {
      bloat: 1,
      caloriesPer100g: 89,
      proteinPer100g: 1.1,
      fatPer100g: 0.3,
      carbsPer100g: 23,
      weightPerUnit: 118
    },
    steak: {
      bloat: 7,
      caloriesPer100g: 250,
      proteinPer100g: 26,
      fatPer100g: 20,
      carbsPer100g: 0,
      weightPerUnit: 200
    },
    apple: {
      bloat: 2,
      caloriesPer100g: 52,
      proteinPer100g: 0.3,
      fatPer100g: 0.2,
      carbsPer100g: 14,
      weightPerUnit: 182
    },
    chickenbreast: {
      bloat: 3,
      caloriesPer100g: 165,
      proteinPer100g: 31,
      fatPer100g: 3.6,
      carbsPer100g: 0,
      weightPerUnit: 150
    },
    broccoli: {
      bloat: 5,
      caloriesPer100g: 34,
      proteinPer100g: 2.8,
      fatPer100g: 0.4,
      carbsPer100g: 7,
      weightPerUnit: 91
    },
    egg: {
      bloat: 1,
      caloriesPer100g: 155,
      proteinPer100g: 13,
      fatPer100g: 11,
      carbsPer100g: 1.1,
      weightPerUnit: 50
    },
    rice: {
      bloat: 4,
      caloriesPer100g: 130,
      proteinPer100g: 2.7,
      fatPer100g: 0.3,
      carbsPer100g: 28,
      weightPerUnit: 100
    },
    salmon: {
      bloat: 3,
      caloriesPer100g: 206,
      proteinPer100g: 22,
      fatPer100g: 12,
      carbsPer100g: 0,
      weightPerUnit: 154
    },
    avocado: {
      bloat: 2,
      caloriesPer100g: 160,
      proteinPer100g: 2,
      fatPer100g: 15,
      carbsPer100g: 9,
      weightPerUnit: 150
    },
    almond: {
      bloat: 2,
      caloriesPer100g: 579,
      proteinPer100g: 21,
      fatPer100g: 50,
      carbsPer100g: 22,
      weightPerUnit: 1
    },
    yogurt: {
      bloat: 4,
      caloriesPer100g: 59,
      proteinPer100g: 10,
      fatPer100g: 0.4,
      carbsPer100g: 3.6,
      weightPerUnit: 100
    },
    potato: {
      bloat: 5,
      caloriesPer100g: 77,
      proteinPer100g: 2,
      fatPer100g: 0.1,
      carbsPer100g: 17,
      weightPerUnit: 150
    },
    carrot: {
      bloat: 1,
      caloriesPer100g: 41,
      proteinPer100g: 0.9,
      fatPer100g: 0.2,
      carbsPer100g: 10,
      weightPerUnit: 61
    },
    oats: {
      bloat: 4,
      caloriesPer100g: 389,
      proteinPer100g: 17,
      fatPer100g: 7,
      carbsPer100g: 66,
      weightPerUnit: 40
    },
    wheyprotein: {
      bloat: 2,
      caloriesPer100g: 400,
      proteinPer100g: 80,
      fatPer100g: 7,
      carbsPer100g: 8,
      weightPerUnit: 30
    },
    bread: {
      bloat: 3,
      caloriesPer100g: 265,
      proteinPer100g: 9,
      fatPer100g: 3.2,
      carbsPer100g: 49,
      weightPerUnit: 30
    },
    cheese: {
      bloat: 3,
      caloriesPer100g: 402,
      proteinPer100g: 25,
      fatPer100g: 33,
      carbsPer100g: 1.3,
      weightPerUnit: 30
    },
    peanutbutter: {
      bloat: 4,
      caloriesPer100g: 588,
      proteinPer100g: 25,
      fatPer100g: 50,
      carbsPer100g: 20,
      weightPerUnit: 32
    }
  };

  // Load custom foods from localStorage
  const loadCustomFoods = () => {
    const custom = localStorage.getItem('customFoods');
    if (custom) {
      try {
        const parsed = JSON.parse(custom);
        Object.assign(foodDB, parsed);
      } catch {}
    }
  };

  const saveCustomFoods = () => {
    const customOnly = {};
    for (const key in foodDB) {
      if (foodDB[key].custom) customOnly[key] = foodDB[key];
    }
    localStorage.setItem('customFoods', JSON.stringify(customOnly));
  };

  loadCustomFoods
