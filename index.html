<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DietMax.io</title>
<style>
    :root {
        --primary-color: #6c5ce7;
        --primary-hover: #5649c0;
        --danger-color: #ff7675;
        --danger-hover: #e84343;
        --success-color: #00b894;
        --success-hover: #00a884;
        --info-color: #0984e3;
        --info-hover: #0776c8;
        --text-color: #2d3436;
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
        --border-color: #dfe6e9;
        --modal-bg: rgba(0, 0, 0, 0.5);
        --modal-content-bg: #ffffff;
        --suggestion-hover-bg: #f0f0f0; /* New for suggestions */
        --suggestion-selected-bg: #e0e0e0; /* New for suggestions */
        --table-header-bg: #e9ecef; /* New for table header */
    }

    .dark-mode {
        --primary-color: #a29bfe;
        --primary-hover: #847bff;
        --danger-color: #ff7675;
        --danger-hover: #e84343;
        --success-color: #55efc4;
        --success-hover: #00b894;
        --info-color: #74b9ff;
        --info-hover: #0984e3;
        --text-color: #f5f6fa;
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --border-color: #333333;
        --modal-bg: rgba(255, 255, 255, 0.2);
        --modal-content-bg: #2d2d2d;
        --suggestion-hover-bg: #444; /* New for suggestions */
        --suggestion-selected-bg: #555; /* New for suggestions */
        --table-header-bg: #2d2d2d; /* New for table header */
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 700px;
        margin: auto;
        padding: 20px;
        background: var(--bg-color);
        color: var(--text-color);
        transition: all 0.3s ease;
    }

    h1, h2 {
        text-align: center;
        margin-bottom: 15px;
        color: var(--primary-color);
    }

    label {
        font-weight: 600;
        margin-top: 12px;
        display: block;
        color: var(--text-color);
    }

    input[type=number], input[type=text], select, input[type=file] {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        box-sizing: border-box;
        font-size: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        background-color: var(--card-bg);
        color: var(--text-color);
    }

    button {
        margin-top: 12px;
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        background-color: var(--primary-color);
        color: white;
        border-radius: 5px;
        transition: all 0.2s ease;
        font-size: 0.95rem;
    }

    button:hover {
        background-color: var(--primary-hover);
        transform: translateY(-1px);
    }

    button:active {
        transform: translateY(0);
    }

    .btn-danger {
        background-color: var(--danger-color);
    }

    .btn-danger:hover {
        background-color: var(--danger-hover);
    }

    .btn-success {
        background-color: var(--success-color);
    }

    .btn-success:hover {
        background-color: var(--success-hover);
    }

    .btn-info {
        background-color: var(--info-color);
    }

    .btn-info:hover {
        background-color: var(--info-hover);
    }

    .section {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        position: relative; /* Crucial for positioning dropdown */
    }

    /* Meal Log Table/Grid Styles */
    .meal-log-container {
        overflow-x: auto; /* Enable horizontal scrolling if needed */
        max-width: 100%;
    }

    .meal-log-grid {
        display: grid;
        /* Define columns for Name, Kcal, P, F, C, S, Na, Bloat, Actions */
        grid-template-columns: 2fr repeat(7, minmax(40px, 0.7fr)) auto; /* Adjust as needed */
        gap: 5px;
        align-items: center;
        padding: 0;
        margin: 0;
        min-width: 650px; /* Ensure minimum width for all columns to fit */
    }

    .meal-log-header, .list-item {
        display: contents; /* Makes children participate in grid layout */
    }

    .meal-log-header .grid-cell {
        font-weight: 600;
        background-color: var(--table-header-bg);
        padding: 8px 5px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 10;
        white-space: nowrap; /* Prevent headers from wrapping */
    }
    .meal-log-header .grid-cell:first-child { text-align: left; padding-left: 10px; }
    .meal-log-header .grid-cell:last-child { text-align: right; padding-right: 10px; }


    .list-item {
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s ease;
    }
    .list-item:hover {
        background-color: var(--suggestion-hover-bg);
    }
    .list-item:last-of-type {
        border-bottom: none;
    }

    .list-item .grid-cell {
        padding: 8px 5px;
        text-align: center;
        white-space: nowrap; /* Prevent data from wrapping */
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .list-item .grid-cell.food-name {
        text-align: left;
        padding-left: 10px;
        font-weight: 500;
        color: var(--primary-color);
    }
    .list-item .grid-cell.actions {
        text-align: right;
        padding-right: 10px;
        display: flex;
        justify-content: flex-end;
        gap: 5px;
    }
    .list-item .grid-cell.actions button {
        margin: 0;
        padding: 6px 10px;
        font-size: 0.8rem;
    }


    .flex-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .flex-row > div {
        flex: 1;
        min-width: 140px;
    }

    .progress-bar-container {
        background: var(--border-color);
        border-radius: 15px;
        height: 22px;
        overflow: hidden;
        margin-top: 15px;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--success-color);
        width: 0;
        transition: width 0.3s ease;
    }

    .small-label {
        font-weight: normal;
        font-size: 0.85rem;
        color: var(--text-color);
        opacity: 0.8;
    }

    /* Autocomplete Suggestions Styles */
    .suggestions-dropdown {
        position: absolute;
        top: calc(85px + 10px); /* Adjust based on label height and input height */
        left: 20px; /* Aligned with section padding */
        right: 20px; /* Aligned with section padding */
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 100; /* Ensure it's above other content */
        display: none; /* Hidden by default */
        list-style: none; /* If using ul/li */
        padding: 0;
        margin: 0;
    }
    .dark-mode .suggestions-dropdown {
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-color);
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item:hover,
    .suggestion-item.selected { /* For keyboard navigation */
        background-color: var(--suggestion-hover-bg);
        color: var(--text-color);
    }

    /* Modal styles */
    .modal-bg {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background-color: var(--modal-bg);
        justify-content: center;
        align-items: center;
    }

    .modal-bg.show {
        display: flex;
    }

    .modal-content {
        background-color: var(--modal-content-bg);
        margin: auto;
        padding: 25px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: relative; /* Needed for close button positioning */
        color: var(--text-color);
    }

    .modal-close {
        color: var(--text-color);
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .modal-close:hover,
    .modal-close:focus {
        color: var(--danger-color);
        text-decoration: none;
        cursor: pointer;
    }

    .header-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .empty-state {
        text-align: center;
        padding: 20px;
        color: var(--text-color);
        opacity: 0.7;
    }

    .modal-content h2 {
        margin-top: 0;
        color: var(--primary-color);
    }

    .modal-content p {
        margin-bottom: 8px;
    }

    .store-links a {
        display: block;
        margin-bottom: 5px;
        color: var(--info-color);
        text-decoration: none;
    }

    .store-links a:hover {
        text-decoration: underline;
    }
</style>
</head>
<body>

<div class="header-controls">
    <h1>DietMax.io</h1>
    <button id="darkModeToggle" class="btn-info">Toggle Dark Mode</button>
</div>

<div class="section" id="inputSection">
    <label for="foodInput">Food Name</label>
    <input id="foodInput" type="text" placeholder="e.g. chicken, apple, rice" autocomplete="off" />
    <div id="foodSuggestions" class="suggestions-dropdown"></div>

    <div class="flex-row">
        <div>
            <label for="amountInput">Amount</label>
            <input id="amountInput" type="number" min="0" placeholder="e.g. 150" />
        </div>
        <div>
            <label for="portionTypeSelect">Portion Type</label>
            <select id="portionTypeSelect">
                <option value="grams">Grams (g)</option>
                <option value="servings">Servings</option>
            </select>
        </div>
    </div>

    <label for="mealPhotoInput">Meal Photo (optional)</label>
    <input id="mealPhotoInput" type="file" accept="image/*" capture="environment" />

    <button id="addMealBtn" class="btn-success">Add Meal to Log</button>
</div>

<div class="section">
    <button id="openSettingsModalBtn" class="btn-info">Settings ⚙️</button>
</div>

<div class="section" id="totalsSection">
    <h2>Daily Totals</h2>
    <div>Calories: <span id="totalCalories">0</span> kcal</div>
    <div>Protein: <span id="totalProtein">0</span> g</div>
    <div>Fat: <span id="totalFat">0</span> g</div>
    <div>Carbs: <span id="totalCarbs">0</span> g</div>
    <div>Sugar: <span id="totalSugar">0</span> g</div>
    <div>Sodium: <span id="totalSodium">0</span> mg</div>
    <div>Bloat Scale: <span id="totalBloatScale">0</span></div>

    <div class="progress-bar-container" title="Calories Progress">
        <div id="calorieProgress" class="progress-bar"></div>
    </div>
</div>

<div class="section" id="mealLogSection">
    <h2>Meal Log</h2>
    <div id="mealHistoryDiv" class="empty-state">No meals logged yet.</div>
</div>

<div id="imageModalBg" class="modal-bg"><img id="modalImage" alt="Meal photo" /></div>

<div id="settingsModalBg" class="modal-bg">
    <div class="modal-content">
        <span class="modal-close" id="closeSettingsModal">&times;</span>
        <h2>Settings</h2>
        <label for="calorieGoalInput">Daily Calorie Goal (kcal)</label>
        <input id="calorieGoalInput" type="number" min="500" max="10000" step="50" />

        <label for="unitPreferenceSelect">Unit Preference</label>
        <select id="unitPreferenceSelect">
            <option value="metric">Metric (g, ml)</option>
            <option value="imperial">Imperial (oz, fl oz)</option>
        </select>

        <button id="saveSettingsBtn" class="btn-success">Save Settings</button>
    </div>
</div>

<div id="foodInfoModalBg" class="modal-bg">
    <div class="modal-content">
        <span class="modal-close" id="closeFoodInfoModal">&times;</span>
        <h2 id="foodInfoTitle"></h2>
        <h3>Macros per 100g:</h3>
        <p>Calories: <span id="infoCalories100g"></span> kcal</p>
        <p>Protein: <span id="infoProtein100g"></span> g</p>
        <p>Fat: <span id="infoFat100g"></span> g</p>
        <p>Carbs: <span id="infoCarbs100g"></span> g</p>
        <p>Sugar: <span id="infoSugar100g"></span> g</p>
        <p>Sodium: <span id="infoSodium100g"></span> mg</p>
        <p>Bloat Scale: <span id="infoBloatScale100g"></span> /10</p>

        <h3>Macros per Serving:</h3>
        <p>Serving Size: <span id="infoServingSize"></span></p>
        <p>Calories: <span id="infoCaloriesServing"></span> kcal</p>
        <p>Protein: <span id="infoProteinServing"></span> g</p>
        <p>Fat: <span id="infoFatServing"></span> g</p>
        <p>Carbs: <span id="infoCarbsServing"></span> g</p>
        <p>Sugar: <span id="infoSugarServing"></span> g</p>
        <p>Sodium: <span id="infoSodiumServing"></span> mg</p>

        <h3>Search on Supermarkets:</h3>
        <div class="store-links">
            <a id="woolworthsLink" href="#" target="_blank">Woolworths</a>
            <a id="paknsaveLink" href="#" target="_blank">Pak'nSave</a>
            <a id="newworldLink" href="#" target="_blank">New World</a>
        </div>
    </div>
</div>

<script src="foodDatabase.js"></script>

<script defer>
    // === Storage keys ===
    const STORAGE_LOG_KEY = "dailyFoodLogWithPhotos";
    const STORAGE_SETTINGS_KEY = "foodTrackerSettings";

    // === Load persisted data ===
    let dailyLog = JSON.parse(localStorage.getItem(STORAGE_LOG_KEY)) || [];
    let settings = JSON.parse(localStorage.getItem(STORAGE_SETTINGS_KEY)) || {
        calorieGoal: 2500,
        unitPreference: "metric",
    };

    // === DOM elements ===
    const foodInput = document.getElementById("foodInput");
    const foodSuggestionsDiv = document.getElementById("foodSuggestions");
    const amountInput = document.getElementById("amountInput");
    const portionTypeSelect = document.getElementById("portionTypeSelect");
    const mealPhotoInput = document.getElementById("mealPhotoInput");
    const addMealBtn = document.getElementById("addMealBtn");

    const totalCaloriesSpan = document.getElementById("totalCalories");
    const totalProteinSpan = document.getElementById("totalProtein");
    const totalFatSpan = document.getElementById("totalFat");
    const totalCarbsSpan = document.getElementById("totalCarbs");
    const totalSugarSpan = document.getElementById("totalSugar"); // New
    const totalSodiumSpan = document.getElementById("totalSodium"); // New
    const totalBloatScaleSpan = document.getElementById("totalBloatScale"); // New
    const calorieProgressBar = document.getElementById("calorieProgress");

    const mealHistoryDiv = document.getElementById("mealHistoryDiv");

    const openSettingsModalBtn = document.getElementById("openSettingsModalBtn");
    const settingsModalBg = document.getElementById("settingsModalBg");
    const closeSettingsModal = document.getElementById("closeSettingsModal");
    const calorieGoalInput = document.getElementById("calorieGoalInput");
    const unitPreferenceSelect = document.getElementById("unitPreferenceSelect");
    const saveSettingsBtn = document.getElementById("saveSettingsBtn");

    const imageModalBg = document.getElementById("imageModalBg");
    const modalImage = document.getElementById("modalImage");
    const darkModeToggle = document.getElementById('darkModeToggle');

    const foodInfoModalBg = document.getElementById("foodInfoModalBg");
    const closeFoodInfoModal = document.getElementById("closeFoodInfoModal");
    const foodInfoTitle = document.getElementById("foodInfoTitle");
    const infoCalories100g = document.getElementById("infoCalories100g");
    const infoProtein100g = document.getElementById("infoProtein100g");
    const infoFat100g = document.getElementById("infoFat100g");
    const infoCarbs100g = document.getElementById("infoCarbs100g");
    const infoSugar100g = document.getElementById("infoSugar100g"); // New
    const infoSodium100g = document.getElementById("infoSodium100g"); // New
    const infoBloatScale100g = document.getElementById("infoBloatScale100g"); // New
    const infoServingSize = document.getElementById("infoServingSize");
    const infoCaloriesServing = document.getElementById("infoCaloriesServing");
    const infoProteinServing = document.getElementById("infoProteinServing");
    const infoFatServing = document.getElementById("infoFatServing");
    const infoCarbsServing = document.getElementById("infoCarbsServing");
    const infoSugarServing = document.getElementById("infoSugarServing"); // New
    const infoSodiumServing = document.getElementById("infoSodiumServing"); // New
    const woolworthsLink = document.getElementById("woolworthsLink");
    const paknsaveLink = document.getElementById("paknsaveLink");
    const newworldLink = document.getElementById("newworldLink");

    // === Autocomplete variables ===
    let currentSuggestions = [];
    let selectedSuggestionIndex = -1;

    // === Initialize dark mode ===
    function initDarkMode() {
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
        }
    }

    // Toggle dark mode
    darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
    });

    // === Helpers ===
    function fmt(n) {
        return n.toFixed(1);
    }
    function normalizeName(name) {
        return name.trim().toLowerCase().replace(/\s+/g, '');
    }

    // === Unit conversion helpers ===
    function convertWeightToPreferredUnit(g) {
        if (settings.unitPreference === "imperial") {
            return (g / 28.3495).toFixed(1) + " oz";
        }
        return g.toFixed(1) + " g";
    }

    // === Save helpers ===
    function saveLog(log) {
        localStorage.setItem(STORAGE_LOG_KEY, JSON.stringify(log));
    }
    function saveSettings(settingsObj) {
        localStorage.setItem(STORAGE_SETTINGS_KEY, JSON.stringify(settingsObj));
    }

    // === Calculate macros based on amount and portion type ===
    function calculateMacros(foodData, amount, portionType) {
        let factor;
        let calculatedWeight;

        if (portionType === "grams") {
            factor = amount / 100;
            calculatedWeight = amount;
        } else if (portionType === "servings") {
            calculatedWeight = amount * (foodData.weightPerUnit || 100);
            factor = calculatedWeight / 100;
        } else {
            return null;
        }

        return {
            calories: foodData.caloriesPer100g * factor,
            protein: foodData.proteinPer100g * factor,
            fat: foodData.fatPer100g * factor,
            carbs: foodData.carbsPer100g * factor,
            sugar: foodData.sugarPer100g * factor, // New
            sodium: foodData.sodiumPer100g * factor, // New
            bloatScale: foodData.bloatScale, // Direct value from database, not scaled by amount for total effect
            weight: calculatedWeight,
        };
    }

    // === Autocomplete Functions ===
    foodInput.addEventListener('input', showFoodSuggestions);
    foodInput.addEventListener('keydown', handleFoodInputKeydown);

    function showFoodSuggestions() {
        const inputVal = normalizeName(foodInput.value);
        foodSuggestionsDiv.innerHTML = '';
        currentSuggestions = [];
        selectedSuggestionIndex = -1;

        if (inputVal.length === 0) {
            foodSuggestionsDiv.style.display = 'none';
            return;
        }

        const foodNames = Object.keys(foodsDatabase);

        const matchingFoods = foodNames.filter(name => name.startsWith(inputVal))
                                       .sort((a, b) => a.localeCompare(b));

        if (matchingFoods.length > 0) {
            matchingFoods.forEach(foodName => {
                const suggestionItem = document.createElement('div');
                suggestionItem.classList.add('suggestion-item');
                suggestionItem.textContent = foodName.charAt(0).toUpperCase() + foodName.slice(1);
                suggestionItem.dataset.foodName = foodName;

                suggestionItem.addEventListener('click', () => {
                    foodInput.value = suggestionItem.textContent;
                    foodSuggestionsDiv.style.display = 'none';
                });
                foodSuggestionsDiv.appendChild(suggestionItem);
                currentSuggestions.push(suggestionItem);
            });
            foodSuggestionsDiv.style.display = 'block';
        } else {
            foodSuggestionsDiv.style.display = 'none';
        }
    }

    function hideFoodSuggestions() {
        foodSuggestionsDiv.style.display = 'none';
        selectedSuggestionIndex = -1;
    }

    function handleFoodInputKeydown(e) {
        if (foodSuggestionsDiv.style.display === 'block' && currentSuggestions.length > 0) {
            if (selectedSuggestionIndex > -1) {
                currentSuggestions[selectedSuggestionIndex].classList.remove('selected');
            }

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex = (selectedSuggestionIndex + 1) % currentSuggestions.length;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex = (selectedSuggestionIndex - 1 + currentSuggestions.length) % currentSuggestions.length;
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedSuggestionIndex > -1) {
                    currentSuggestions[selectedSuggestionIndex].click();
                } else {
                    addMealBtn.click();
                }
                hideFoodSuggestions();
                return;
            } else if (e.key === 'Escape') {
                hideFoodSuggestions();
                return;
            }

            if (selectedSuggestionIndex > -1) {
                const selectedItem = currentSuggestions[selectedSuggestionIndex];
                selectedItem.classList.add('selected');
                selectedItem.scrollIntoView({ block: 'nearest' });
                foodInput.value = selectedItem.textContent;
            }
        } else if (e.key === 'Enter') {
            addMealBtn.click();
        }
    }

    document.addEventListener('click', (e) => {
        if (!foodInput.contains(e.target) && !foodSuggestionsDiv.contains(e.target)) {
            hideFoodSuggestions();
        }
    });

    // === Add meal to log ===
    addMealBtn.addEventListener("click", () => {
        const foodNameRaw = foodInput.value;
        const normName = normalizeName(foodNameRaw);
        if (!foodNameRaw.trim()) {
            alert("Please enter a food name.");
            return;
        }
        if (!(normName in foodsDatabase)) {
            alert(`Food "${foodNameRaw}" not found in database. Try another or check spelling.`);
            return;
        }
        const amount = parseFloat(amountInput.value);
        if (isNaN(amount) || amount <= 0) {
            alert("Enter a valid positive amount.");
            return;
        }
        const portionType = portionTypeSelect.value;

        const foodData = foodsDatabase[normName];
        const macros = calculateMacros(foodData, amount, portionType);
        if (!macros) {
            alert("Error calculating macros.");
            return;
        }

        const newMeal = {
            name: foodNameRaw,
            normalizedName: normName,
            calories: macros.calories,
            protein: macros.protein,
            fat: macros.fat,
            carbs: macros.carbs,
            sugar: macros.sugar,   // New
            sodium: macros.sodium, // New
            bloatScale: macros.bloatScale, // New
            weight: macros.weight,
            timestamp: Date.now(),
            photo: null,
        };

        const file = mealPhotoInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                newMeal.photo = e.target.result;
                dailyLog.push(newMeal);
                saveLog(dailyLog);
                renderMealHistory();
                updateTotalsAndProgress();
                resetInputs();
            };
            reader.readAsDataURL(file);
        } else {
            dailyLog.push(newMeal);
            saveLog(dailyLog);
            renderMealHistory();
            updateTotalsAndProgress();
            resetInputs();
        }
    });

    // === Reset input fields ===
    function resetInputs() {
        foodInput.value = "";
        amountInput.value = "";
        mealPhotoInput.value = "";
        hideFoodSuggestions();
    }

    // === Render meal log ===
    function renderMealHistory() {
        mealHistoryDiv.innerHTML = "";
        if (dailyLog.length === 0) {
            mealHistoryDiv.innerHTML = '<div class="empty-state">No meals logged yet.</div>';
            return;
        }

        const mealLogContainer = document.createElement('div');
        mealLogContainer.classList.add('meal-log-container');
        const mealLogGrid = document.createElement('div');
        mealLogGrid.classList.add('meal-log-grid');

        // Create header row
        const header = document.createElement('div');
        header.classList.add('meal-log-header');
        const headers = ["Food Name", "Kcal", "P(g)", "F(g)", "C(g)", "Sugar(g)", "Sodium(mg)", "Bloat", "Actions"];
        headers.forEach(text => {
            const cell = document.createElement('div');
            cell.classList.add('grid-cell');
            cell.textContent = text;
            header.appendChild(cell);
        });
        mealLogGrid.appendChild(header);


        // Render each meal item
        dailyLog.forEach((meal, i) => {
            const div = document.createElement("div");
            div.classList.add("list-item");

            const foodNameCell = document.createElement('div');
            foodNameCell.classList.add('grid-cell', 'food-name');
            foodNameCell.textContent = meal.name;
            div.appendChild(foodNameCell);

            const kcalCell = document.createElement('div');
            kcalCell.classList.add('grid-cell');
            kcalCell.textContent = fmt(meal.calories);
            div.appendChild(kcalCell);

            const proteinCell = document.createElement('div');
            proteinCell.classList.add('grid-cell');
            proteinCell.textContent = fmt(meal.protein);
            div.appendChild(proteinCell);

            const fatCell = document.createElement('div');
            fatCell.classList.add('grid-cell');
            fatCell.textContent = fmt(meal.fat);
            div.appendChild(fatCell);

            const carbsCell = document.createElement('div');
            carbsCell.classList.add('grid-cell');
            carbsCell.textContent = fmt(meal.carbs);
            div.appendChild(carbsCell);

            const sugarCell = document.createElement('div'); // New
            sugarCell.classList.add('grid-cell');
            sugarCell.textContent = fmt(meal.sugar);
            div.appendChild(sugarCell);

            const sodiumCell = document.createElement('div'); // New
            sodiumCell.classList.add('grid-cell');
            sodiumCell.textContent = fmt(meal.sodium);
            div.appendChild(sodiumCell);

            const bloatCell = document.createElement('div'); // New
            bloatCell.classList.add('grid-cell');
            bloatCell.textContent = meal.bloatScale; // Bloat scale is an integer
            div.appendChild(bloatCell);

            // Buttons container
            const btnsCell = document.createElement('div');
            btnsCell.classList.add('grid-cell', 'actions');

            const infoBtn = document.createElement("button");
            infoBtn.textContent = "Info";
            infoBtn.classList.add("btn-info");
            infoBtn.title = `Show info for ${meal.name}`;
            infoBtn.addEventListener("click", () => {
                showFoodInfoModal(meal.normalizedName);
            });
            btnsCell.appendChild(infoBtn);

            if (meal.photo) {
                const showImgBtn = document.createElement("button");
                showImgBtn.textContent = "Photo";
                showImgBtn.classList.add("btn-info");
                showImgBtn.title = "View meal photo";
                showImgBtn.addEventListener("click", () => {
                    modalImage.src = meal.photo;
                    imageModalBg.classList.add("show");
                });
                btnsCell.appendChild(showImgBtn);
            }

            const delBtn = document.createElement("button");
            delBtn.textContent = "Delete";
            delBtn.classList.add("btn-danger");
            delBtn.title = "Delete this meal from log";
            delBtn.addEventListener("click", () => {
                if (confirm(`Delete meal "${meal.name}"?`)) {
                    dailyLog.splice(i, 1);
                    saveLog(dailyLog);
                    renderMealHistory();
                    updateTotalsAndProgress();
                }
            });
            btnsCell.appendChild(delBtn);

            div.appendChild(btnsCell);
            mealLogGrid.appendChild(div);
        });
        mealLogContainer.appendChild(mealLogGrid);
        mealHistoryDiv.appendChild(mealLogContainer);
    }

    // === Update totals and calorie progress bar ===
    function updateTotalsAndProgress() {
        let totalCalories = 0,
            totalProtein = 0,
            totalFat = 0,
            totalCarbs = 0,
            totalSugar = 0,    // New
            totalSodium = 0,   // New
            totalBloatScale = 0; // New

        dailyLog.forEach((meal) => {
            totalCalories += meal.calories;
            totalProtein += meal.protein;
            totalFat += meal.fat;
            totalCarbs += meal.carbs;
            totalSugar += meal.sugar;      // New
            totalSodium += meal.sodium;    // New
            totalBloatScale += meal.bloatScale; // New - Summing bloat scale
        });

        totalCaloriesSpan.textContent = fmt(totalCalories);
        totalProteinSpan.textContent = fmt(totalProtein);
        totalFatSpan.textContent = fmt(totalFat);
        totalCarbsSpan.textContent = fmt(totalCarbs);
        totalSugarSpan.textContent = fmt(totalSugar);     // New
        totalSodiumSpan.textContent = fmt(totalSodium);   // New
        totalBloatScaleSpan.textContent = totalBloatScale; // Bloat scale is int, no fmt

        const pct = Math.min((totalCalories / settings.calorieGoal) * 100, 100);
        calorieProgressBar.style.width = pct + "%";
    }

    // === Settings Modal functionality ===
    openSettingsModalBtn.addEventListener("click", () => {
        calorieGoalInput.value = settings.calorieGoal;
        unitPreferenceSelect.value = settings.unitPreference;
        settingsModalBg.classList.add("show");
    });

    closeSettingsModal.addEventListener("click", () => {
        settingsModalBg.classList.remove("show");
    });

    saveSettingsBtn.addEventListener("click", () => {
        const goal = parseInt(calorieGoalInput.value, 10);
        if (isNaN(goal) || goal < 500 || goal > 10000) {
            alert("Enter a valid calorie goal between 500 and 10,000.");
            return;
        }
        settings.calorieGoal = goal;
        settings.unitPreference = unitPreferenceSelect.value;
        saveSettings(settings);
        updateTotalsAndProgress();
        renderMealHistory();
        alert("Settings saved.");
        settingsModalBg.classList.remove("show");
    });

    // === Food Info Modal functionality ===
    function showFoodInfoModal(foodNormalizedName) {
        const foodData = foodsDatabase[foodNormalizedName];
        if (!foodData) {
            alert("Food data not found for " + foodNormalizedName);
            return;
        }

        foodInfoTitle.textContent = foodNormalizedName.charAt(0).toUpperCase() + foodNormalizedName.slice(1);

        // Macros per 100g
        infoCalories100g.textContent = fmt(foodData.caloriesPer100g);
        infoProtein100g.textContent = fmt(foodData.proteinPer100g);
        infoFat100g.textContent = fmt(foodData.fatPer100g);
        infoCarbs100g.textContent = fmt(foodData.carbsPer100g);
        infoSugar100g.textContent = fmt(foodData.sugarPer100g);     // New
        infoSodium100g.textContent = fmt(foodData.sodiumPer100g);   // New
        infoBloatScale100g.textContent = foodData.bloatScale; // New

        // Macros per serving
        const servingWeight = foodData.weightPerUnit || 100;
        const servingFactor = servingWeight / 100;

        infoServingSize.textContent = convertWeightToPreferredUnit(servingWeight);
        infoCaloriesServing.textContent = fmt(foodData.caloriesPer100g * servingFactor);
        infoProteinServing.textContent = fmt(foodData.proteinPer100g * servingFactor);
        infoFatServing.textContent = fmt(foodData.fatPer100g * servingFactor);
        infoCarbsServing.textContent = fmt(foodData.carbsPer100g * servingFactor);
        infoSugarServing.textContent = fmt(foodData.sugarPer100g * servingFactor);    // New
        infoSodiumServing.textContent = fmt(foodData.sodiumPer100g * servingFactor);  // New

        // Supermarket links
        const encodedFoodName = encodeURIComponent(foodNormalizedName);
        woolworthsLink.href = `https://www.woolworths.co.nz/shop/searchproducts?search=${encodedFoodName}`;
        paknsaveLink.href = `https://www.paknsave.co.nz/shop/search?pg=1&q=${encodedFoodName}`;
        newworldLink.href = `https://www.newworld.co.nz/shop/search?pg=1&q=${encodedFoodName}`;

        foodInfoModalBg.classList.add("show");
    }

    closeFoodInfoModal.addEventListener("click", () => {
        foodInfoModalBg.classList.remove("show");
    });

    // === Modal close on background click for all modals ===
    imageModalBg.addEventListener("click", (e) => {
        if (e.target === imageModalBg) {
            imageModalBg.classList.remove("show");
            modalImage.src = "";
        }
    });

    settingsModalBg.addEventListener("click", (e) => {
        if (e.target === settingsModalBg) {
            settingsModalBg.classList.remove("show");
        }
    });

    foodInfoModalBg.addEventListener("click", (e) => {
        if (e.target === foodInfoModalBg) {
            foodInfoModalBg.classList.remove("show");
        }
    });

    // === Initialize ===
    initDarkMode();
    renderMealHistory();
    updateTotalsAndProgress();
</script>

</body>
</html>
