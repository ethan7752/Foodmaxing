<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Progressive Overload Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1a1a1a;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #fb923c;
            border-radius: 10px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #ea580c;
        }
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-black text-orange-500 min-h-screen flex items-center justify-center p-4">
    <div id="app-container" class="bg-gray-900 border border-gray-700 rounded-xl shadow-lg w-full max-w-md p-6">
        <h1 class="text-3xl font-bold text-center mb-6 text-orange-500">Gym Tracker</h1>

        <div id="loading-message" class="text-xl font-semibold text-center text-orange-400 hidden">Loading application...</div>
        <div id="error-message" class="text-xl font-semibold text-center text-red-400 p-4 hidden"></div>

        <div id="exercise-list-view">
            <input
                type="text"
                id="search-input"
                placeholder="Search exercises..."
                class="w-full p-3 mb-4 bg-gray-800 text-orange-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 placeholder-gray-500"
            />
            <div id="exercises-container" class="max-h-96 overflow-y-auto custom-scrollbar space-y-2">
                </div>
            <p id="no-exercises-found" class="text-center text-gray-500 text-lg py-4 hidden">No exercises found.</p>
        </div>

        <div id="exercise-detail-view" class="hidden">
            <h2 id="detail-exercise-name" class="text-2xl font-bold text-orange-500 mb-6 text-center"></h2>

            <div class="flex items-center justify-between mb-4">
                <button id="prev-session-button" class="p-2 bg-gray-800 hover:bg-gray-700 text-orange-300 font-bold rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    &lt; Previous
                </button>
                <span id="session-date" class="text-lg font-medium text-orange-300"></span>
                <button id="next-session-button" class="p-2 bg-gray-800 hover:bg-gray-700 text-orange-300 font-bold rounded-lg transition-colors duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                    Next &gt;
                </button>
            </div>

            <div class="flex flex-col items-start mb-4 bg-gray-900 border border-gray-700 p-4 rounded-lg shadow-inner">
                <label class="text-lg font-medium text-orange-300 mb-2">Weight (kg):</label>
                <div class="flex items-center w-full">
                    <button id="weight-decrease" class="p-2 bg-red-700 hover:bg-red-800 rounded-full w-10 h-10 flex items-center justify-center text-xl font-bold text-white shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 flex-shrink-0">-</button>
                    <input type="number" id="weight-input" class="flex-grow mx-3 p-2 text-center bg-gray-800 text-orange-300 rounded-md text-xl font-semibold focus:outline-none focus:ring-2 focus:ring-orange-500 min-w-0" min="0">
                    <button id="weight-increase" class="p-2 bg-green-700 hover:bg-green-800 rounded-full w-10 h-10 flex items-center justify-center text-xl font-bold text-white shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 flex-shrink-0">+</button>
                </div>
            </div>

            <div class="flex flex-col items-start mb-4 bg-gray-900 border border-gray-700 p-4 rounded-lg shadow-inner">
                <label class="text-lg font-medium text-orange-300 mb-2">Reps:</label>
                <div class="flex items-center w-full">
                    <button id="reps-decrease" class="p-2 bg-red-700 hover:bg-red-800 rounded-full w-10 h-10 flex items-center justify-center text-xl font-bold text-white shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 flex-shrink-0">-</button>
                    <input type="number" id="reps-input" class="flex-grow mx-3 p-2 text-center bg-gray-800 text-orange-300 rounded-md text-xl font-semibold focus:outline-none focus:ring-2 focus:ring-orange-500 min-w-0" min="0">
                    <button id="reps-increase" class="p-2 bg-green-700 hover:bg-green-800 rounded-full w-10 h-10 flex items-center justify-center text-xl font-bold text-white shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 flex-shrink-0">+</button>
                </div>
            </div>

            <div class="flex flex-col items-start mb-4 bg-gray-900 border border-gray-700 p-4 rounded-lg shadow-inner">
                <label class="text-lg font-medium text-orange-300 mb-2">Sets:</label>
                <div class="flex items-center w-full">
                    <button id="sets-decrease" class="p-2 bg-red-700 hover:bg-red-800 rounded-full w-10 h-10 flex items-center justify-center text-xl font-bold text-white shadow-md focus:outline-none focus:ring-2 focus:ring-red-500 flex-shrink-0">-</button>
                    <input type="number" id="sets-input" class="flex-grow mx-3 p-2 text-center bg-gray-800 text-orange-300 rounded-md text-xl font-semibold focus:outline-none focus:ring-2 focus:ring-orange-500 min-w-0" min="0">
                    <button id="sets-increase" class="p-2 bg-green-700 hover:bg-green-800 rounded-full w-10 h-10 flex items-center justify-center text-xl font-bold text-white shadow-md focus:outline-none focus:ring-2 focus:ring-green-500 flex-shrink-0">+</button>
                </div>
            </div>

            <button id="save-new-session-button" class="w-full bg-orange-600 hover:bg-orange-700 text-black font-bold py-3 px-4 rounded-lg shadow-lg transition-colors duration-200 mb-4 focus:outline-none focus:ring-2 focus:ring-orange-500">
                Save New Session
            </button>
            <p id="save-message" class="text-center text-sm mb-4"></p>

            <div id="chart-container" class="mt-8">
                <canvas id="progressChart" class="bg-gray-800 p-4 rounded-lg"></canvas>
            </div>

            <button id="back-button" class="w-full bg-gray-800 hover:bg-gray-700 text-orange-300 font-bold py-3 px-4 rounded-lg shadow-lg transition-colors duration-200 mt-4 focus:outline-none focus:ring-2 focus:ring-gray-500">
                Back to Exercises
            </button>
        </div>
    </div>

    <script>
        // Exercise List
        const EXERCISES = [
            "Barbell curl", "Dumbell curl", "Hammer curl", "Preacher curl", "Cable curl", "Machine curl",
            "Bicep pulldown", "Tricep pulldown", "Tricep pushdown", "Overhead rope extention", "Skull crushers",
            "Forearm cable curls", "Hammer rope curl", "Lat pulldown", "Lat row", "Machine row", "Machine pulldown",
            "Bench press", "Incline bench press", "Incline smith machine bench press", "Lat pullover", "Pec deck",
            "Dumbell chest press", "Machine press", "Machine incline press", "Cable fly's", "Dumbell shoulder press",
            "Machine shoulder press", "Machine laterial raises", "Dumbell laterial raises", "Rear delt face pull",
            "Reverse pec deck", "Cable laterial raises", "Ab crunch machine", "Ab crunch machine with legs."
        ];

        // --- DOM Element References ---
        const loadingMessage = document.getElementById('loading-message');
        const errorMessage = document.getElementById('error-message');
        const exerciseListView = document.getElementById('exercise-list-view');
        const exerciseDetailView = document.getElementById('exercise-detail-view');
        const searchInput = document.getElementById('search-input');
        const exercisesContainer = document.getElementById('exercises-container');
        const noExercisesFound = document.getElementById('no-exercises-found');
        const detailExerciseName = document.getElementById('detail-exercise-name');
        const sessionDateSpan = document.getElementById('session-date');
        const prevSessionButton = document.getElementById('prev-session-button');
        const nextSessionButton = document.getElementById('next-session-button');
        const weightInput = document.getElementById('weight-input');
        const repsInput = document.getElementById('reps-input');
        const setsInput = document.getElementById('sets-input');
        const saveNewSessionButton = document.getElementById('save-new-session-button');
        const saveMessage = document.getElementById('save-message');
        const backButton = document.getElementById('back-button');
        const progressChartCanvas = document.getElementById('progressChart');
        let progressChart = null;

        // --- Global Variables for App State ---
        let currentSelectedExercise = null;
        let allFetchedExerciseData = {};
        let currentSessionIndex = -1;

        // --- Utility Functions ---

        /** Shows either the list view or the detail view, hiding the other. */
        function showView(viewName) {
            exerciseListView.classList.add('hidden');
            exerciseDetailView.classList.add('hidden');
            if (viewName === 'list') {
                exerciseListView.classList.remove('hidden');
            } else if (viewName === 'detail') {
                exerciseDetailView.classList.remove('hidden');
            }
        }

        /** Saves all exercise data to localStorage. */
        function saveAllExerciseDataToLocalStorage() {
            try {
                localStorage.setItem('gymTrackerData', JSON.stringify(allFetchedExerciseData));
            } catch (e) {
                console.error("Error saving to localStorage:", e);
                errorMessage.textContent = "Error saving data. Storage might be full or unavailable.";
                errorMessage.classList.remove('hidden');
            }
        }

        /** Loads all exercise data from localStorage. */
        function loadAllExerciseDataFromLocalStorage() {
            try {
                const storedData = localStorage.getItem('gymTrackerData');
                if (storedData) {
                    allFetchedExerciseData = JSON.parse(storedData);
                } else {
                    initializeDefaultExerciseData();
                }
            } catch (e) {
                console.error("Error loading from localStorage:", e);
                errorMessage.textContent = "Error loading data. Data might be corrupted.";
                errorMessage.classList.remove('hidden');
                initializeDefaultExerciseData();
            }
        }

        /** Initializes all exercises with default values if no data exists. */
        function initializeDefaultExerciseData() {
            EXERCISES.forEach(exerciseName => {
                if (!allFetchedExerciseData[exerciseName]) {
                    allFetchedExerciseData[exerciseName] = {
                        name: exerciseName,
                        history: []
                    };
                }
            });
            saveAllExerciseDataToLocalStorage();
        }

        // --- UI Rendering Functions ---

        /** Renders the list of exercises based on the provided array. */
        function renderExerciseList(filteredExercises) {
            exercisesContainer.innerHTML = '';
            if (filteredExercises.length === 0) {
                noExercisesFound.classList.remove('hidden');
            } else {
                noExercisesFound.classList.add('hidden');
                filteredExercises.forEach(exercise => {
                    const button = document.createElement('button');
                    button.className = 'w-full text-left p-3 bg-gray-900 border border-gray-700 hover:bg-orange-700 hover:border-orange-700 transition-colors duration-200 rounded-lg text-lg font-medium shadow-md text-orange-300';
                    button.textContent = exercise;
                    button.onclick = () => showExerciseDetail(exercise);
                    const li = document.createElement('li');
                    li.appendChild(button);
                    exercisesContainer.appendChild(li);
                });
            }
        }

        /** Populates the detail view with data for the selected exercise. */
        function showExerciseDetail(exerciseName) {
            currentSelectedExercise = exerciseName;
            detailExerciseName.textContent = exerciseName;
            
            const history = allFetchedExerciseData[exerciseName]?.history || [];
            currentSessionIndex = history.length > 0 ? history.length - 1 : -1;
            
            updateSessionDisplay();
            showView('detail');
            renderChart(history);
        }

        /** Updates the input fields and date based on the current session index. */
        function updateSessionDisplay() {
            const exerciseData = allFetchedExerciseData[currentSelectedExercise];
            if (!exerciseData || !exerciseData.history || exerciseData.history.length === 0) {
                // No sessions exist
                weightInput.value = 0;
                repsInput.value = 0;
                setsInput.value = 0;
                sessionDateSpan.textContent = 'No sessions logged';
                prevSessionButton.disabled = true;
                nextSessionButton.disabled = true;
                saveNewSessionButton.classList.remove('hidden');
                return;
            }

            const isLatestSession = currentSessionIndex === exerciseData.history.length - 1;
            const session = exerciseData.history[currentSessionIndex];

            // Update inputs and date
            weightInput.value = session.weight;
            repsInput.value = session.reps;
            setsInput.value = session.sets;
            sessionDateSpan.textContent = `Session on ${session.date}`;

            // Disable/enable navigation buttons
            prevSessionButton.disabled = currentSessionIndex <= 0;
            nextSessionButton.disabled = isLatestSession;
            
            // Show "Save New Session" only on the most recent entry
            saveNewSessionButton.classList.toggle('hidden', !isLatestSession);

            // Make inputs editable only for the most recent session
            weightInput.disabled = !isLatestSession;
            repsInput.disabled = !isLatestSession;
            setsInput.disabled = !isLatestSession;
            document.getElementById('weight-decrease').disabled = !isLatestSession;
            document.getElementById('weight-increase').disabled = !isLatestSession;
            document.getElementById('reps-decrease').disabled = !isLatestSession;
            document.getElementById('reps-increase').disabled = !isLatestSession;
            document.getElementById('sets-decrease').disabled = !isLatestSession;
            document.getElementById('sets-increase').disabled = !isLatestSession;
        }

        /** Increases or decreases a numerical input's value, preventing negative numbers. */
        function updateValue(inputElement, increment) {
            let currentValue = Number(inputElement.value);
            currentValue = Math.max(0, currentValue + increment);
            inputElement.value = currentValue;
        }

        /** Saves the current exercise's data to the history and updates last session. */
        function saveNewSession() {
            if (!currentSelectedExercise) {
                saveMessage.textContent = "Error: No exercise selected.";
                saveMessage.className = 'text-center text-sm text-red-400 mb-4';
                return;
            }

            const newEntry = {
                date: new Date().toLocaleDateString(),
                weight: Number(weightInput.value),
                reps: Number(repsInput.value),
                sets: Number(setsInput.value)
            };

            const exerciseData = allFetchedExerciseData[currentSelectedExercise];
            if (!exerciseData.history) {
                exerciseData.history = [];
            }
            exerciseData.history.push(newEntry);
            saveAllExerciseDataToLocalStorage();

            // Reset to the latest session to show the newly saved one
            currentSessionIndex = exerciseData.history.length - 1;
            updateSessionDisplay();

            saveMessage.textContent = "Session saved successfully!";
            saveMessage.className = 'text-center text-sm text-green-400 mb-4';
            setTimeout(() => { saveMessage.textContent = ''; }, 3000);

            renderChart(exerciseData.history);
        }

        /** Renders the line chart using Chart.js. */
        function renderChart(history) {
            const chartContainer = document.getElementById('chart-container');
            if (progressChart) {
                progressChart.destroy();
            }

            if (!history || history.length < 2) {
                chartContainer.style.display = 'none';
                return;
            }

            chartContainer.style.display = 'block';

            const labels = history.map(entry => entry.date);
            const weights = history.map(entry => entry.weight);
            const reps = history.map(entry => entry.reps);
            const sets = history.map(entry => entry.sets);

            const data = {
                labels: labels,
                datasets: [
                    {
                        label: 'Weight (kg)',
                        data: weights,
                        borderColor: 'rgb(251, 146, 60)',
                        tension: 0.4
                    },
                    {
                        label: 'Reps',
                        data: reps,
                        borderColor: 'rgb(249, 115, 22)',
                        tension: 0.4
                    },
                    {
                        label: 'Sets',
                        data: sets,
                        borderColor: 'rgb(234, 88, 12)',
                        tension: 0.4
                    }
                ]
            };

            const config = {
                type: 'line',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: { color: 'rgb(253, 186, 116)' },
                            grid: { color: 'rgba(107, 114, 128, 0.2)' }
                        },
                        y: {
                            ticks: { color: 'rgb(253, 186, 116)' },
                            grid: { color: 'rgba(107, 114, 128, 0.2)' }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: 'rgb(253, 186, 116)'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Progress Over Time',
                            color: 'rgb(251, 146, 60)'
                        }
                    }
                }
            };
            progressChart = new Chart(progressChartCanvas, config);
        }

        // --- Event Listeners ---

        searchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filtered = EXERCISES.filter(exercise => exercise.toLowerCase().includes(query));
            renderExerciseList(filtered);
        });

        prevSessionButton.addEventListener('click', () => {
            if (currentSessionIndex > 0) {
                currentSessionIndex--;
                updateSessionDisplay();
            }
        });

        nextSessionButton.addEventListener('click', () => {
            const history = allFetchedExerciseData[currentSelectedExercise]?.history || [];
            if (currentSessionIndex < history.length - 1) {
                currentSessionIndex++;
                updateSessionDisplay();
            }
        });

        document.getElementById('weight-decrease').addEventListener('click', () => updateValue(weightInput, -1));
        document.getElementById('weight-increase').addEventListener('click', () => updateValue(weightInput, 1));
        document.getElementById('reps-decrease').addEventListener('click', () => updateValue(repsInput, -1));
        document.getElementById('reps-increase').addEventListener('click', () => updateValue(repsInput, 1));
        document.getElementById('sets-decrease').addEventListener('click', () => updateValue(setsInput, -1));
        document.getElementById('sets-increase').addEventListener('click', () => updateValue(setsInput, 1));

        saveNewSessionButton.addEventListener('click', saveNewSession);

        backButton.addEventListener('click', () => {
            currentSelectedExercise = null;
            currentSessionIndex = -1;
            searchInput.value = '';
            renderExerciseList(EXERCISES);
            showView('list');
            if (progressChart) {
                progressChart.destroy();
                progressChart = null;
            }
        });

        // --- Application Initialization on Window Load ---

        window.onload = function() {
            loadingMessage.classList.remove('hidden');
            loadAllExerciseDataFromLocalStorage();
            renderExerciseList(EXERCISES);
            loadingMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
            showView('list');
        };
    </script>
</body>
</html>
