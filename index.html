<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DietMax.io</title>
<style>
    :root {
        --primary-color: #6c5ce7;
        --primary-hover: #5649c0;
        --danger-color: #ff7675;
        --danger-hover: #e84343;
        --success-color: #00b894;
        --success-hover: #00a884;
        --info-color: #0984e3;
        --info-hover: #0776c8;
        --text-color: #2d3436;
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
        --border-color: #dfe6e9;
        --modal-bg: rgba(0, 0, 0, 0.5);
        --modal-content-bg: #ffffff;
        --suggestion-hover-bg: #f0f0f0; /* New for suggestions */
        --suggestion-selected-bg: #e0e0e0; /* New for suggestions */
    }

    .dark-mode {
        --primary-color: #a29bfe;
        --primary-hover: #847bff;
        --danger-color: #ff7675;
        --danger-hover: #e84343;
        --success-color: #55efc4;
        --success-hover: #00b894;
        --info-color: #74b9ff;
        --info-hover: #0984e3;
        --text-color: #f5f6fa;
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --border-color: #333333;
        --modal-bg: rgba(255, 255, 255, 0.2);
        --modal-content-bg: #2d2d2d;
        --suggestion-hover-bg: #444; /* New for suggestions */
        --suggestion-selected-bg: #555; /* New for suggestions */
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 700px;
        margin: auto;
        padding: 20px;
        background: var(--bg-color);
        color: var(--text-color);
        transition: all 0.3s ease;
    }

    h1, h2 {
        text-align: center;
        margin-bottom: 15px;
        color: var(--primary-color);
    }

    label {
        font-weight: 600;
        margin-top: 12px;
        display: block;
        color: var(--text-color);
    }

    input[type=number], input[type=text], select, input[type=file] {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        box-sizing: border-box;
        font-size: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        background-color: var(--card-bg);
        color: var(--text-color);
    }

    button {
        margin-top: 12px;
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        background-color: var(--primary-color);
        color: white;
        border-radius: 5px;
        transition: all 0.2s ease;
        font-size: 0.95rem;
    }

    button:hover {
        background-color: var(--primary-hover);
        transform: translateY(-1px);
    }

    button:active {
        transform: translateY(0);
    }

    .btn-danger {
        background-color: var(--danger-color);
    }

    .btn-danger:hover {
        background-color: var(--danger-hover);
    }

    .btn-success {
        background-color: var(--success-color);
    }

    .btn-success:hover {
        background-color: var(--success-hover);
    }

    .btn-info {
        background-color: var(--info-color);
    }

    .btn-info:hover {
        background-color: var(--info-hover);
    }

    .section {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        position: relative; /* Crucial for positioning dropdown */
    }

    #mealHistoryDiv .list-item {
        background: var(--card-bg);
        padding: 15px;
        margin: 10px 0;
        border-radius: 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border: 1px solid var(--border-color);
        transition: transform 0.2s ease;
    }

    #mealHistoryDiv .list-item:hover {
        transform: translateX(5px);
    }

    #mealHistoryDiv .list-item div {
        flex: 1;
    }

    #mealHistoryDiv button {
        margin-left: 10px;
        padding: 8px 12px;
        font-size: 0.85rem;
    }

    .flex-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .flex-row > div {
        flex: 1;
        min-width: 140px;
    }

    .progress-bar-container {
        background: var(--border-color);
        border-radius: 15px;
        height: 22px;
        overflow: hidden;
        margin-top: 15px;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--success-color);
        width: 0;
        transition: width 0.3s ease;
    }

    .small-label {
        font-weight: normal;
        font-size: 0.85rem;
        color: var(--text-color);
        opacity: 0.8;
    }

    /* Autocomplete Suggestions Styles */
    .suggestions-dropdown {
        position: absolute;
        top: calc(85px + 10px); /* Adjust based on label height and input height */
        left: 20px; /* Aligned with section padding */
        right: 20px; /* Aligned with section padding */
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 100; /* Ensure it's above other content */
        display: none; /* Hidden by default */
        list-style: none; /* If using ul/li */
        padding: 0;
        margin: 0;
    }
    .dark-mode .suggestions-dropdown {
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-color);
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item:hover,
    .suggestion-item.selected { /* For keyboard navigation */
        background-color: var(--suggestion-hover-bg);
        color: var(--text-color);
    }

    /* Modal styles */
    .modal-bg {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background-color: var(--modal-bg);
        justify-content: center;
        align-items: center;
    }

    .modal-bg.show {
        display: flex;
    }

    .modal-content {
        background-color: var(--modal-content-bg);
        margin: auto;
        padding: 25px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: relative; /* Needed for close button positioning */
        color: var(--text-color);
    }

    .modal-close {
        color: var(--text-color);
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .modal-close:hover,
    .modal-close:focus {
        color: var(--danger-color);
        text-decoration: none;
        cursor: pointer;
    }

    .header-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .empty-state {
        text-align: center;
        padding: 20px;
        color: var(--text-color);
        opacity: 0.7;
    }

    .modal-content h2 {
        margin-top: 0;
        color: var(--primary-color);
    }

    .modal-content p {
        margin-bottom: 8px;
    }

    .store-links a {
        display: block;
        margin-bottom: 5px;
        color: var(--info-color);
        text-decoration: none;
    }

    .store-links a:hover {
        text-decoration: underline;
    }
</style>
</head>
<body>

<div class="header-controls">
    <h1>DietMax.io</h1>
    <button id="darkModeToggle" class="btn-info">Toggle Dark Mode</button>
</div>

<div class="section" id="inputSection">
    <label for="foodInput">Food Name</label>
    <input id="foodInput" type="text" placeholder="e.g. chicken, apple, rice" autocomplete="off" />
    <div id="foodSuggestions" class="suggestions-dropdown"></div>

    <div class="flex-row">
        <div>
            <label for="amountInput">Amount</label>
            <input id="amountInput" type="number" min="0" placeholder="e.g. 150" />
        </div>
        <div>
            <label for="portionTypeSelect">Portion Type</label>
            <select id="portionTypeSelect">
                <option value="grams">Grams (g)</option>
                <option value="servings">Servings</option>
            </select>
        </div>
    </div>

    <label for="mealPhotoInput">Meal Photo (optional)</label>
    <input id="mealPhotoInput" type="file" accept="image/*" capture="environment" />

    <button id="addMealBtn" class="btn-success">Add Meal to Log</button>
</div>

<div class="section">
    <button id="openSettingsModalBtn" class="btn-info">Settings ⚙️</button>
</div>

<div class="section" id="totalsSection">
    <h2>Daily Totals</h2>
    <div>Calories: <span id="totalCalories">0</span> kcal</div>
    <div>Protein: <span id="totalProtein">0</span> g</div>
    <div>Fat: <span id="totalFat">0</span> g</div>
    <div>Carbs: <span id="totalCarbs">0</span> g</div>

    <div class="progress-bar-container" title="Calories Progress">
        <div id="calorieProgress" class="progress-bar"></div>
    </div>
</div>

<div class="section" id="mealLogSection">
    <h2>Meal Log</h2>
    <div id="mealHistoryDiv" class="empty-state">No meals logged yet.</div>
</div>

<div id="imageModalBg" class="modal-bg"><img id="modalImage" alt="Meal photo" /></div>

<div id="settingsModalBg" class="modal-bg">
    <div class="modal-content">
        <span class="modal-close" id="closeSettingsModal">&times;</span>
        <h2>Settings</h2>
        <label for="calorieGoalInput">Daily Calorie Goal (kcal)</label>
        <input id="calorieGoalInput" type="number" min="500" max="10000" step="50" />

        <label for="unitPreferenceSelect">Unit Preference</label>
        <select id="unitPreferenceSelect">
            <option value="metric">Metric (g, ml)</option>
            <option value="imperial">Imperial (oz, fl oz)</option>
        </select>

        <button id="saveSettingsBtn" class="btn-success">Save Settings</button>
    </div>
</div>

<div id="foodInfoModalBg" class="modal-bg">
    <div class="modal-content">
        <span class="modal-close" id="closeFoodInfoModal">&times;</span>
        <h2 id="foodInfoTitle"></h2>
        <h3>Macros per 100g:</h3>
        <p>Calories: <span id="infoCalories100g"></span> kcal</p>
        <p>Protein: <span id="infoProtein100g"></span> g</p>
        <p>Fat: <span id="infoFat100g"></span> g</p>
        <p>Carbs: <span id="infoCarbs100g"></span> g</p>

        <h3>Macros per Serving:</h3>
        <p>Serving Size: <span id="infoServingSize"></span></p>
        <p>Calories: <span id="infoCaloriesServing"></span> kcal</p>
        <p>Protein: <span id="infoProteinServing"></span> g</p>
        <p>Fat: <span id="infoFatServing"></span> g</p>
        <p>Carbs: <span id="infoCarbsServing"></span> g</p>

        <h3>Search on Supermarkets:</h3>
        <div class="store-links">
            <a id="woolworthsLink" href="#" target="_blank">Woolworths</a>
            <a id="paknsaveLink" href="#" target="_blank">Pak'nSave</a>
            <a id="newworldLink" href="#" target="_blank">New World</a>
        </div>
    </div>
</div>

<script src="foodDatabase.js"></script>

<script defer>
    // === Storage keys ===
    const STORAGE_LOG_KEY = "dailyFoodLogWithPhotos";
    const STORAGE_SETTINGS_KEY = "foodTrackerSettings";

    // === Load persisted data ===
    let dailyLog = JSON.parse(localStorage.getItem(STORAGE_LOG_KEY)) || [];
    let settings = JSON.parse(localStorage.getItem(STORAGE_SETTINGS_KEY)) || {
        calorieGoal: 2500,
        unitPreference: "metric",
    };

    // === DOM elements ===
    const foodInput = document.getElementById("foodInput");
    const foodSuggestionsDiv = document.getElementById("foodSuggestions"); // New
    const amountInput = document.getElementById("amountInput");
    const portionTypeSelect = document.getElementById("portionTypeSelect");
    const mealPhotoInput = document.getElementById("mealPhotoInput");
    const addMealBtn = document.getElementById("addMealBtn");

    const totalCaloriesSpan = document.getElementById("totalCalories");
    const totalProteinSpan = document.getElementById("totalProtein");
    const totalFatSpan = document.getElementById("totalFat");
    const totalCarbsSpan = document.getElementById("totalCarbs");
    const calorieProgressBar = document.getElementById("calorieProgress");

    const mealHistoryDiv = document.getElementById("mealHistoryDiv");

    const openSettingsModalBtn = document.getElementById("openSettingsModalBtn");
    const settingsModalBg = document.getElementById("settingsModalBg");
    const closeSettingsModal = document.getElementById("closeSettingsModal");
    const calorieGoalInput = document.getElementById("calorieGoalInput");
    const unitPreferenceSelect = document.getElementById("unitPreferenceSelect");
    const saveSettingsBtn = document.getElementById("saveSettingsBtn");

    const imageModalBg = document.getElementById("imageModalBg");
    const modalImage = document.getElementById("modalImage");
    const darkModeToggle = document.getElementById('darkModeToggle');

    const foodInfoModalBg = document.getElementById("foodInfoModalBg");
    const closeFoodInfoModal = document.getElementById("closeFoodInfoModal");
    const foodInfoTitle = document.getElementById("foodInfoTitle");
    const infoCalories100g = document.getElementById("infoCalories100g");
    const infoProtein100g = document.getElementById("infoProtein100g");
    const infoFat100g = document.getElementById("infoFat100g");
    const infoCarbs100g = document.getElementById("infoCarbs100g");
    const infoServingSize = document.getElementById("infoServingSize");
    const infoCaloriesServing = document.getElementById("infoCaloriesServing");
    const infoProteinServing = document.getElementById("infoProteinServing");
    const infoFatServing = document.getElementById("infoFatServing");
    const infoCarbsServing = document.getElementById("infoCarbsServing");
    const woolworthsLink = document.getElementById("woolworthsLink");
    const paknsaveLink = document.getElementById("paknsaveLink");
    const newworldLink = document.getElementById("newworldLink");

    // === Autocomplete variables ===
    let currentSuggestions = [];
    let selectedSuggestionIndex = -1;

    // === Initialize dark mode ===
    function initDarkMode() {
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
        }
    }

    // Toggle dark mode
    darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
    });

    // === Helpers ===
    function fmt(n) {
        return n.toFixed(1);
    }
    function normalizeName(name) {
        return name.trim().toLowerCase().replace(/\s+/g, '');
    }

    // === Unit conversion helpers ===
    function convertWeightToPreferredUnit(g) {
        if (settings.unitPreference === "imperial") {
            return (g / 28.3495).toFixed(1) + " oz";
        }
        return g.toFixed(1) + " g";
    }

    // === Save helpers ===
    function saveLog(log) {
        localStorage.setItem(STORAGE_LOG_KEY, JSON.stringify(log));
    }
    function saveSettings(settingsObj) {
        localStorage.setItem(STORAGE_SETTINGS_KEY, JSON.stringify(settingsObj));
    }

    // === Calculate macros based on amount and portion type ===
    function calculateMacros(foodData, amount, portionType) {
        let factor;
        let calculatedWeight;

        if (portionType === "grams") {
            factor = amount / 100;
            calculatedWeight = amount;
        } else if (portionType === "servings") {
            // If the food has a defined weight per unit, use it. Otherwise, assume 1 serving = 100g for calculation consistency.
            calculatedWeight = amount * (foodData.weightPerUnit || 100);
            factor = calculatedWeight / 100;
        } else {
            return null; // Should not happen with current select options
        }

        return {
            calories: foodData.caloriesPer100g * factor,
            protein: foodData.proteinPer100g * factor,
            fat: foodData.fatPer100g * factor,
            carbs: foodData.carbsPer100g * factor,
            weight: calculatedWeight,
        };
    }

    // === Autocomplete Functions ===
    foodInput.addEventListener('input', showFoodSuggestions);
    foodInput.addEventListener('keydown', handleFoodInputKeydown);

    function showFoodSuggestions() {
        const inputVal = normalizeName(foodInput.value);
        foodSuggestionsDiv.innerHTML = ''; // Clear previous suggestions
        currentSuggestions = [];
        selectedSuggestionIndex = -1;

        if (inputVal.length === 0) {
            foodSuggestionsDiv.style.display = 'none';
            return;
        }

        // Get all food names from the database
        const foodNames = Object.keys(foodsDatabase);

        // Filter and sort suggestions
        const matchingFoods = foodNames.filter(name => name.startsWith(inputVal))
                                       .sort((a, b) => a.localeCompare(b)); // Alphabetical sort

        if (matchingFoods.length > 0) {
            matchingFoods.forEach(foodName => {
                const suggestionItem = document.createElement('div');
                suggestionItem.classList.add('suggestion-item');
                // Display the food name, capitalize first letter for display
                suggestionItem.textContent = foodName.charAt(0).toUpperCase() + foodName.slice(1);
                suggestionItem.dataset.foodName = foodName; // Store normalized name

                suggestionItem.addEventListener('click', () => {
                    foodInput.value = suggestionItem.textContent;
                    foodSuggestionsDiv.style.display = 'none';
                });
                foodSuggestionsDiv.appendChild(suggestionItem);
                currentSuggestions.push(suggestionItem);
            });
            foodSuggestionsDiv.style.display = 'block';
        } else {
            foodSuggestionsDiv.style.display = 'none';
        }
    }

    function hideFoodSuggestions() {
        foodSuggestionsDiv.style.display = 'none';
        selectedSuggestionIndex = -1;
    }

    // Handle keyboard navigation for suggestions
    function handleFoodInputKeydown(e) {
        if (foodSuggestionsDiv.style.display === 'block' && currentSuggestions.length > 0) {
            // Remove selection from previous item
            if (selectedSuggestionIndex > -1) {
                currentSuggestions[selectedSuggestionIndex].classList.remove('selected');
            }

            if (e.key === 'ArrowDown') {
                e.preventDefault(); // Prevent cursor movement
                selectedSuggestionIndex = (selectedSuggestionIndex + 1) % currentSuggestions.length;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault(); // Prevent cursor movement
                selectedSuggestionIndex = (selectedSuggestionIndex - 1 + currentSuggestions.length) % currentSuggestions.length;
            } else if (e.key === 'Enter') {
                e.preventDefault(); // Prevent form submission
                if (selectedSuggestionIndex > -1) {
                    currentSuggestions[selectedSuggestionIndex].click(); // Simulate click
                } else {
                    // If Enter is pressed without selecting from dropdown,
                    // proceed with adding meal as if no autocomplete was used.
                    addMealBtn.click();
                }
                hideFoodSuggestions();
                return; // Exit to prevent further processing by input event
            } else if (e.key === 'Escape') {
                hideFoodSuggestions();
                return;
            }

            // Add selection to new item and scroll into view
            if (selectedSuggestionIndex > -1) {
                const selectedItem = currentSuggestions[selectedSuggestionIndex];
                selectedItem.classList.add('selected');
                selectedItem.scrollIntoView({ block: 'nearest' });
                // Optionally update input value on arrow key navigation
                foodInput.value = selectedItem.textContent;
            }
        } else if (e.key === 'Enter') {
            // If suggestions are not open, but Enter is pressed, try to add meal
            addMealBtn.click();
        }
    }

    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
        if (!foodInput.contains(e.target) && !foodSuggestionsDiv.contains(e.target)) {
            hideFoodSuggestions();
        }
    });

    // === Add meal to log ===
    addMealBtn.addEventListener("click", () => {
        const foodNameRaw = foodInput.value;
        const normName = normalizeName(foodNameRaw);
        if (!foodNameRaw.trim()) {
            alert("Please enter a food name.");
            return;
        }
        // This is where foodsDatabase is used, it must be defined by now.
        if (!(normName in foodsDatabase)) {
            alert(`Food "${foodNameRaw}" not found in database. Try another or check spelling.`);
            return;
        }
        const amount = parseFloat(amountInput.value);
        if (isNaN(amount) || amount <= 0) {
            alert("Enter a valid positive amount.");
            return;
        }
        const portionType = portionTypeSelect.value;

        const foodData = foodsDatabase[normName];
        const macros = calculateMacros(foodData, amount, portionType);
        if (!macros) {
            alert("Error calculating macros.");
            return;
        }

        const file = mealPhotoInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                const base64Image = e.target.result;
                dailyLog.push({
                    name: foodNameRaw,
                    normalizedName: normName, // Store normalized name for info lookup
                    calories: macros.calories,
                    protein: macros.protein,
                    fat: macros.fat,
                    carbs: macros.carbs,
                    weight: macros.weight,
                    timestamp: Date.now(),
                    photo: base64Image,
                });
                saveLog(dailyLog);
                renderMealHistory();
                updateTotalsAndProgress();
                resetInputs();
            };
            reader.readAsDataURL(file);
        } else {
            dailyLog.push({
                name: foodNameRaw,
                normalizedName: normName, // Store normalized name for info lookup
                calories: macros.calories,
                protein: macros.protein,
                fat: macros.fat,
                carbs: macros.carbs,
                weight: macros.weight,
                timestamp: Date.now(),
                photo: null,
            });
            saveLog(dailyLog);
            renderMealHistory();
            updateTotalsAndProgress();
            resetInputs();
        }
    });

    // === Reset input fields ===
    function resetInputs() {
        foodInput.value = "";
        amountInput.value = "";
        mealPhotoInput.value = "";
        hideFoodSuggestions(); // Hide suggestions after adding meal
    }

    // === Render meal log ===
    function renderMealHistory() {
        mealHistoryDiv.innerHTML = "";
        if (dailyLog.length === 0) {
            mealHistoryDiv.innerHTML = '<div class="empty-state">No meals logged yet.</div>';
            return;
        }

        dailyLog.forEach((meal, i) => {
            const div = document.createElement("div");
            div.classList.add("list-item");

            const mealInfoDiv = document.createElement("div");
            mealInfoDiv.innerHTML = `<strong>${meal.name}</strong><br>
                ${fmt(meal.calories)} kcal | P: ${fmt(meal.protein)}g | F: ${fmt(meal.fat)}g | C: ${fmt(meal.carbs)}g | ${convertWeightToPreferredUnit(meal.weight)}`;

            div.appendChild(mealInfoDiv);

            // Buttons container
            const btnsDiv = document.createElement("div");
            btnsDiv.style.display = "flex";
            btnsDiv.style.alignItems = "center"; // Align buttons vertically

            // Info button
            const infoBtn = document.createElement("button");
            infoBtn.textContent = "Info";
            infoBtn.classList.add("btn-info");
            infoBtn.title = `Show info for ${meal.name}`;
            infoBtn.addEventListener("click", () => {
                showFoodInfoModal(meal.normalizedName);
            });
            btnsDiv.appendChild(infoBtn);


            if (meal.photo) {
                const showImgBtn = document.createElement("button");
                showImgBtn.textContent = "Show Image";
                showImgBtn.classList.add("btn-info");
                showImgBtn.title = "View meal photo";
                showImgBtn.addEventListener("click", () => {
                    modalImage.src = meal.photo;
                    imageModalBg.classList.add("show");
                });
                btnsDiv.appendChild(showImgBtn);
            }

            const delBtn = document.createElement("button");
            delBtn.textContent = "Delete";
            delBtn.classList.add("btn-danger");
            delBtn.title = "Delete this meal from log";
            delBtn.addEventListener("click", () => {
                if (confirm(`Delete meal "${meal.name}"?`)) {
                    dailyLog.splice(i, 1);
                    saveLog(dailyLog);
                    renderMealHistory();
                    updateTotalsAndProgress();
                }
            });
            btnsDiv.appendChild(delBtn);

            div.appendChild(btnsDiv);
            mealHistoryDiv.appendChild(div);
        });
    }

    // === Update totals and calorie progress bar ===
    function updateTotalsAndProgress() {
        let totalCalories = 0,
            totalProtein = 0,
            totalFat = 0,
            totalCarbs = 0;
        dailyLog.forEach((meal) => {
            totalCalories += meal.calories;
            totalProtein += meal.protein;
            totalFat += meal.fat;
            totalCarbs += meal.carbs;
        });
        totalCaloriesSpan.textContent = fmt(totalCalories);
        totalProteinSpan.textContent = fmt(totalProtein);
        totalFatSpan.textContent = fmt(totalFat);
        totalCarbsSpan.textContent = fmt(totalCarbs);

        const pct = Math.min((totalCalories / settings.calorieGoal) * 100, 100);
        calorieProgressBar.style.width = pct + "%";
    }

    // === Settings Modal functionality ===
    openSettingsModalBtn.addEventListener("click", () => {
        calorieGoalInput.value = settings.calorieGoal;
        unitPreferenceSelect.value = settings.unitPreference;
        settingsModalBg.classList.add("show");
    });

    closeSettingsModal.addEventListener("click", () => {
        settingsModalBg.classList.remove("show");
    });

    saveSettingsBtn.addEventListener("click", () => {
        const goal = parseInt(calorieGoalInput.value, 10);
        if (isNaN(goal) || goal < 500 || goal > 10000) {
            alert("Enter a valid calorie goal between 500 and 10,000.");
            return;
        }
        settings.calorieGoal = goal;
        settings.unitPreference = unitPreferenceSelect.value;
        saveSettings(settings);
        updateTotalsAndProgress();
        renderMealHistory(); // Re-render to update units in log if changed
        alert("Settings saved.");
        settingsModalBg.classList.remove("show");
    });

    // === Food Info Modal functionality ===
    function showFoodInfoModal(foodNormalizedName) {
        // This is where foodsDatabase is used, it must be defined by now.
        const foodData = foodsDatabase[foodNormalizedName];
        if (!foodData) {
            alert("Food data not found for " + foodNormalizedName);
            return;
        }

        foodInfoTitle.textContent = foodNormalizedName.charAt(0).toUpperCase() + foodNormalizedName.slice(1); // Capitalize first letter

        // Macros per 100g
        infoCalories100g.textContent = fmt(foodData.caloriesPer100g);
        infoProtein100g.textContent = fmt(foodData.proteinPer100g);
        infoFat100g.textContent = fmt(foodData.fatPer100g);
        infoCarbs100g.textContent = fmt(foodData.carbsPer100g);

        // Macros per serving
        const servingWeight = foodData.weightPerUnit || 100; // Default to 100g if weightPerUnit is not defined
        const servingFactor = servingWeight / 100;

        infoServingSize.textContent = convertWeightToPreferredUnit(servingWeight);
        infoCaloriesServing.textContent = fmt(foodData.caloriesPer100g * servingFactor);
        infoProteinServing.textContent = fmt(foodData.proteinPer100g * servingFactor);
        infoFatServing.textContent = fmt(foodData.fatPer100g * servingFactor);
        infoCarbsServing.textContent = fmt(foodData.carbsPer100g * servingFactor);

        // Supermarket links
        const encodedFoodName = encodeURIComponent(foodNormalizedName);
        woolworthsLink.href = `https://www.woolworths.co.nz/shop/searchproducts?search=${encodedFoodName}`;
        paknsaveLink.href = `https://www.paknsave.co.nz/shop/search?pg=1&q=${encodedFoodName}`;
        newworldLink.href = `https://www.newworld.co.nz/shop/search?pg=1&q=${encodedFoodName}`;

        foodInfoModalBg.classList.add("show");
    }

    closeFoodInfoModal.addEventListener("click", () => {
        foodInfoModalBg.classList.remove("show");
    });

    // === Modal close on background click for all modals ===
    imageModalBg.addEventListener("click", (e) => {
        if (e.target === imageModalBg) {
            imageModalBg.classList.remove("show");
            modalImage.src = "";
        }
    });

    settingsModalBg.addEventListener("click", (e) => {
        if (e.target === settingsModalBg) {
            settingsModalBg.classList.remove("show");
        }
    });

    foodInfoModalBg.addEventListener("click", (e) => {
        if (e.target === foodInfoModalBg) {
            foodInfoModalBg.classList.remove("show");
        }
    });

    // === Initialize ===
    // These functions should run after the DOM is ready and all scripts are loaded.
    // The 'defer' attribute helps with this.
    initDarkMode();
    renderMealHistory();
    updateTotalsAndProgress();
</script>

</body>
</html>
