<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DietMax.io</title>
<style>
    :root {
        --primary-color: #6c5ce7;
        --primary-hover: #5649c0;
        --danger-color: #ff7675;
        --danger-hover: #e84343;
        --success-color: #00b894;
        --success-hover: #00a884;
        --info-color: #0984e3;
        --info-hover: #0776c8;
        --text-color: #2d3436;
        --bg-color: #f8f9fa;
        --card-bg: #ffffff;
        --border-color: #dfe6e9;
        --modal-bg: rgba(0, 0, 0, 0.5);
        --modal-content-bg: #ffffff;
        --suggestion-hover-bg: #f0f0f0;
        --suggestion-selected-bg: #e0e0e0;
        --table-header-bg: #e9ecef;
        --reset-button-bg: #FFC107; /* Orange for reset */
        --reset-button-hover: #e0a800; /* Darker orange */
    }

    .dark-mode {
        --primary-color: #a29bfe;
        --primary-hover: #847bff;
        --danger-color: #ff7675;
        --danger-hover: #e84343;
        --success-color: #55efc4;
        --success-hover: #00b894;
        --info-color: #74b9ff;
        --info-hover: #0984e3;
        --text-color: #f5f6fa;
        --bg-color: #121212;
        --card-bg: #1e1e1e;
        --border-color: #333333;
        --modal-bg: rgba(255, 255, 255, 0.2);
        --modal-content-bg: #2d2d2d;
        --suggestion-hover-bg: #444;
        --suggestion-selected-bg: #555;
        --table-header-bg: #2d2d2d;
        --reset-button-bg: #d4ac0d; /* Darker orange for dark mode */
        --reset-button-hover: #b8900c;
    }

    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        max-width: 700px;
        margin: auto;
        padding: 20px;
        background: var(--bg-color);
        color: var(--text-color);
        transition: all 0.3s ease;
    }

    h1, h2 {
        text-align: center;
        margin-bottom: 15px;
        color: var(--primary-color);
    }

    label {
        font-weight: 600;
        margin-top: 12px;
        display: block;
        color: var(--text-color);
    }

    input[type=number], input[type=text], select, input[type=file] {
        width: 100%;
        padding: 10px;
        margin-top: 6px;
        box-sizing: border-box;
        font-size: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 5px;
        background-color: var(--card-bg);
        color: var(--text-color);
    }

    button {
        margin-top: 12px;
        padding: 10px 16px;
        font-weight: 600;
        cursor: pointer;
        border: none;
        background-color: var(--primary-color);
        color: white;
        border-radius: 5px;
        transition: all 0.2s ease;
        font-size: 0.95rem;
    }

    button:hover {
        background-color: var(--primary-hover);
        transform: translateY(-1px);
    }

    button:active {
        transform: translateY(0);
    }

    .btn-danger {
        background-color: var(--danger-color);
    }

    .btn-danger:hover {
        background-color: var(--danger-hover);
    }

    .btn-success {
        background-color: var(--success-color);
    }

    .btn-success:hover {
        background-color: var(--success-hover);
    }

    .btn-info {
        background-color: var(--info-color);
    }

    .btn-info:hover {
        background-color: var(--info-hover);
    }

    .section {
        background: var(--card-bg);
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        margin-bottom: 20px;
        border: 1px solid var(--border-color);
        position: relative;
    }

    /* Meal Log Table/Grid Styles */
    .meal-log-container {
        overflow-x: auto;
        max-width: 100%;
    }

    .meal-log-grid {
        display: grid;
        /* Updated column template for full words and info button under food name */
        grid-template-columns: 1.8fr 0.8fr 0.7fr 0.7fr 0.7fr 0.7fr 0.7fr 0.7fr min-content; /* Adjust auto for action column */
        gap: 5px;
        align-items: flex-start; /* Align items to the top for stacked info button */
        padding: 0;
        margin: 0;
        min-width: 750px; /* Ensure minimum width for all columns to fit */
    }

    .meal-log-header, .list-item {
        display: contents;
    }

    .meal-log-header .grid-cell {
        font-weight: 600;
        background-color: var(--table-header-bg);
        padding: 8px 5px;
        text-align: center;
        border-bottom: 1px solid var(--border-color);
        position: sticky;
        top: 0;
        z-index: 10;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }
    .meal-log-header .grid-cell:first-child { text-align: left; padding-left: 10px; }
    .meal-log-header .grid-cell:last-child { text-align: center; padding-right: 5px; } /* Center the 'X' header */


    .list-item {
        background: var(--card-bg);
        border-bottom: 1px solid var(--border-color);
        transition: background-color 0.2s ease;
    }
    .list-item:hover {
        background-color: var(--suggestion-hover-bg);
    }
    .list-item:last-of-type {
        border-bottom: none;
    }

    .list-item .grid-cell {
        padding: 8px 5px;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        min-height: 40px; /* Ensure minimum height for rows */
        display: flex; /* Use flex for vertical centering */
        align-items: center; /* Center content vertically */
        justify-content: center; /* Center content horizontally */
    }

    /* Specific styling for the food name cell to stack name and info button */
    .list-item .grid-cell.food-name {
        text-align: left;
        padding-left: 10px;
        font-weight: 500;
        color: var(--primary-color);
        flex-direction: column; /* Stack children vertically */
        align-items: flex-start; /* Align food name and button to the left */
        justify-content: center;
        white-space: normal; /* Allow food name to wrap */
    }

    .list-item .grid-cell.food-name span {
        margin-bottom: 3px; /* Space between name and button */
        word-break: break-word; /* Allow name to break words */
    }

    .list-item .grid-cell.actions {
        text-align: right;
        padding-right: 10px;
        display: flex;
        justify-content: center; /* Center the delete button */
        gap: 5px; /* No gap needed if only X button */
        align-items: center;
    }
    .list-item .grid-cell.actions button {
        margin: 0;
        padding: 6px 10px;
        font-size: 0.8rem;
    }
    .list-item .grid-cell.actions .btn-danger { /* X button style */
        padding: 4px 10px;
        font-size: 1.1em; /* Larger X */
        font-weight: bold;
        width: auto;
        min-width: 30px;
        border-radius: 3px;
    }
    .list-item .grid-cell.food-name .btn-info { /* Info button specifically under food name */
        padding: 4px 8px;
        font-size: 0.7em;
        width: auto;
        white-space: nowrap;
        border-radius: 3px;
        margin-top: 5px; /* Space from food name */
        align-self: flex-start; /* Align to the start within the column */
    }

    /* New: Show Image Button next to Info button */
    .list-item .grid-cell.food-name .btn-show-image {
        padding: 4px 8px;
        font-size: 0.7em;
        width: auto;
        white-space: nowrap;
        border-radius: 3px;
        margin-top: 5px; /* Space from food name */
        margin-left: 5px; /* Space from Info button */
        align-self: flex-start; /* Align to the start within the column */
    }


    .flex-row {
        display: flex;
        gap: 15px;
        flex-wrap: wrap;
    }

    .flex-row > div {
        flex: 1;
        min-width: 140px;
    }

    .progress-bar-container {
        background: var(--border-color);
        border-radius: 15px;
        height: 22px;
        overflow: hidden;
        margin-top: 15px;
    }

    .progress-bar {
        height: 100%;
        background-color: var(--success-color);
        width: 0;
        transition: width 0.3s ease;
    }

    .small-label {
        font-weight: normal;
        font-size: 0.85rem;
        color: var(--text-color);
        opacity: 0.8;
    }

    /* Autocomplete Suggestions Styles */
    .suggestions-dropdown {
        position: absolute;
        /* Adjusted top to be relative to the foodInput's parent section, plus input height and margin */
        top: calc(100% + 5px); /* Position below the foodInput within the .section */
        left: 20px;
        right: 20px;
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
        border-top: none;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        max-height: 200px;
        overflow-y: auto;
        z-index: 100;
        display: none;
        list-style: none;
        padding: 0;
        margin: 0;
    }
    .dark-mode .suggestions-dropdown {
        box-shadow: 0 4px 6px rgba(0,0,0,0.3);
    }

    .suggestion-item {
        padding: 10px 15px;
        cursor: pointer;
        border-bottom: 1px solid var(--border-color);
        color: var(--text-color);
    }

    .suggestion-item:last-child {
        border-bottom: none;
    }

    .suggestion-item:hover,
    .suggestion-item.selected {
        background-color: var(--suggestion-hover-bg);
        color: var(--text-color);
    }

    /* Modal styles */
    .modal-bg {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100vw;
        height: 100vh;
        background-color: var(--modal-bg);
        justify-content: center;
        align-items: center;
        overflow-y: auto; /* Allow scrolling for modal content if it gets too long */
    }

    .modal-bg.show {
        display: flex;
    }

    .modal-content {
        background-color: var(--modal-content-bg);
        margin: auto;
        padding: 25px;
        border: 1px solid var(--border-color);
        border-radius: 10px;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        position: relative;
        color: var(--text-color);
        box-sizing: border-box; /* Include padding and border in the element's total width and height */
    }

    /* Added for generic alert/confirm modals */
    .modal-content.small-modal {
        max-width: 400px;
    }

    /* New: Styling for the All Foods Modal */
    #allFoodsModalBg .modal-content {
        max-width: 800px; /* Wider for food list */
        max-height: 90vh; /* Max height for scrolling */
        display: flex;
        flex-direction: column;
    }

    #allFoodsList {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); /* Responsive grid */
        gap: 10px;
        list-style: none;
        padding: 0;
        margin: 20px 0 0 0; /* Space from title */
        overflow-y: auto; /* Allow scrolling within the list */
        flex-grow: 1; /* Allow the list to take available height */
    }

    #allFoodsList li {
        background-color: var(--suggestion-hover-bg); /* Lighter background for items */
        padding: 10px;
        border-radius: 5px;
        cursor: pointer;
        transition: background-color 0.2s ease;
        text-align: center;
        font-weight: 500;
        color: var(--primary-color);
    }

    #allFoodsList li:hover {
        background-color: var(--primary-color);
        color: white;
    }


    .modal-buttons {
        display: flex;
        justify-content: flex-end;
        gap: 10px;
        margin-top: 20px;
    }
    .modal-buttons button {
        margin-top: 0; /* Override default button margin */
    }


    .modal-close {
        color: var(--text-color);
        position: absolute;
        top: 10px;
        right: 15px;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
    }

    .modal-close:hover,
    .modal-close:focus {
        color: var(--danger-color);
        text-decoration: none;
        cursor: pointer;
    }

    .header-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }

    .empty-state {
        text-align: center;
        padding: 20px;
        color: var(--text-color);
        opacity: 0.7;
    }

    .modal-content h2 {
        margin-top: 0;
        color: var(--primary-color);
    }

    .modal-content p {
        margin-bottom: 8px;
    }

    .store-links a {
        display: block;
        margin-bottom: 5px;
        color: var(--info-color);
        text-decoration: none;
    }

    .store-links a:hover {
        text-decoration: underline;
    }

    /* New: Reset History Button Styles */
    .reset-section {
        text-align: center;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid var(--border-color);
    }

    .reset-button {
        background-color: var(--reset-button-bg);
        color: var(--text-color); /* Match text color for better contrast */
        padding: 12px 20px;
        font-size: 1.1em;
        border-radius: 5px;
    }

    .reset-button:hover {
        background-color: var(--reset-button-hover);
        transform: translateY(-1px);
    }

    /* Styles for the meal photo within the log */
    .meal-photo-log {
        grid-column: 1 / -1; /* Spans all columns */
        padding: 10px 0;
        text-align: center;
        border-top: 1px solid var(--border-color); /* Separator */
        background-color: var(--suggestion-hover-bg); /* Light background for photo row */
    }

     .meal-photo-log img {
        max-height: 100px; /* Adjust this value as needed */
        width: auto; /* Keep aspect ratio */
        display: block; /* Prevent extra space below the image */
        margin: 10px auto; /* Center the image in the row */
        border-radius: 8px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
</style>
</head>
<body>

<div class="header-controls">
    <h1>DietMax.io</h1>
    <button id="darkModeToggle" class="btn-info">Toggle Dark Mode</button>
</div>

<div class="section" id="inputSection">
    <h2>Add New Meal</h2>
    <label for="foodInput">Food Name</label>
    <input id="foodInput" type="text" placeholder="e.g. chicken, apple, rice" autocomplete="off" />
    <div id="foodSuggestions" class="suggestions-dropdown"></div>

    <div class="flex-row">
        <div>
            <label for="amountInput">Amount</label>
            <input id="amountInput" type="number" min="0" placeholder="e.g. 150" />
        </div>
        <div>
            <label for="portionTypeSelect">Portion Type</label>
            <select id="portionTypeSelect">
                <option value="grams">Grams (g)</option>
                <option value="servings">Servings</option>
            </select>
        </div>
    </div>

    <label for="mealPhotoInput">Meal Photo (optional)</label>
    <input id="mealPhotoInput" type="file" accept="image/*" capture="environment" />

    <button id="addMealBtn" class="btn-success">Add Meal to Log</button>
</div>

<div class="section">
    <button id="openSettingsModalBtn" class="btn-info">Settings ⚙️</button>
    <button id="showAllFoodsBtn" class="btn-info" style="margin-left: 10px;">Show All Foods 🥗</button>
</div>

<div class="section" id="totalsSection">
    <h2>Daily Totals</h2>
    <div>Calories: <span id="totalCalories">0</span> kcal</div>
    <div>Protein: <span id="totalProtein">0</span> g</div>
    <div>Fat: <span id="totalFat">0</span> g</div>
    <div>Carbs: <span id="totalCarbs">0</span> g</div>
    <div>Sugar: <span id="totalSugar">0</span> g</div>
    <div>Sodium: <span id="totalSodium">0</span> mg</div>
    <div>Total Bloat Score: <span id="totalBloatScale">0</span></div>

    <div class="progress-bar-container" title="Calories Progress">
        <div id="calorieProgress" class="progress-bar"></div>
    </div>
</div>

<div class="section" id="mealLogSection">
    <h2>Meal Log</h2>
    <div id="mealHistoryDiv" class="empty-state">No meals logged yet.</div>
</div>

<div class="reset-section">
    <button id="resetHistoryBtn" class="reset-button">Reset All History</button>
</div>

<!-- Generic Alert Modal -->
<div id="alertModalBg" class="modal-bg">
    <div class="modal-content small-modal">
        <span class="modal-close" id="closeAlertModal">&times;</span>
        <h2 id="alertModalTitle"></h2>
        <p id="alertModalMessage"></p>
        <div class="modal-buttons">
            <button class="btn-primary" id="alertModalOkBtn">OK</button>
        </div>
    </div>
</div>

<!-- Generic Confirm Modal -->
<div id="confirmModalBg" class="modal-bg">
    <div class="modal-content small-modal">
        <span class="modal-close" id="closeConfirmModal">&times;</span>
        <h2 id="confirmModalTitle"></h2>
        <p id="confirmModalMessage"></p>
        <div class="modal-buttons">
            <button class="btn-danger" id="confirmModalCancelBtn">Cancel</button>
            <button class="btn-success" id="confirmModalOkBtn">Confirm</button>
        </div>
    </div>
</div>

<div id="imageModalBg" class="modal-bg">
    <div class="modal-content">
        <span class="modal-close" id="closeImageModal">&times;</span>
        <img id="modalImage" alt="Meal photo" style="max-width: 100%; height: auto; display: block; margin: 0 auto;"/>
    </div>
</div>

<div id="settingsModalBg" class="modal-bg">
    <div class="modal-content">
        <span class="modal-close" id="closeSettingsModal">&times;</span>
        <h2>Settings</h2>
        <label for="calorieGoalInput">Daily Calorie Goal (kcal)</label>
        <input id="calorieGoalInput" type="number" min="500" max="10000" step="50" />

        <label for="unitPreferenceSelect">Unit Preference</label>
        <select id="unitPreferenceSelect">
            <option value="metric">Metric (g, ml)</option>
            <option value="imperial">Imperial (oz, fl oz)</option>
        </select>

        <button id="saveSettingsBtn" class="btn-success">Save Settings</button>
    </div>
</div>

<div id="foodInfoModalBg" class="modal-bg">
    <div class="modal-content">
        <span class="modal-close" id="closeFoodInfoModal">&times;</span>
        <h2 id="foodInfoTitle"></h2>
        <h3>Macros per 100g:</h3>
        <p>Calories: <span id="infoCalories100g"></span> kcal</p>
        <p>Protein: <span id="infoProtein100g"></span> g</p>
        <p>Fat: <span id="infoFat100g"></span> g</p>
        <p>Carbs: <span id="infoCarbs100g"></span> g</p>
        <p>Sugar: <span id="infoSugar100g"></span> g</p>
        <p>Sodium: <span id="infoSodium100g"></span> mg</p>
        <p>Bloat Scale: <span id="infoBloatScale100g"></span> /10</p>

        <h3>Macros per Serving:</h3>
        <p>Serving Size: <span id="infoServingSize"></span></p>
        <p>Calories: <span id="infoCaloriesServing"></span> kcal</p>
        <p>Protein: <span id="infoProteinServing"></span> g</p>
        <p>Fat: <span id="infoFatServing"></span> g</p>
        <p>Carbs: <span id="infoCarbsServing"></span> g</p>
        <p>Sugar: <span id="infoSugarServing"></span> g</p>
        <p>Sodium: <span id="infoSodiumServing"></span> mg</p>

        <h3>Search on Supermarkets:</h3>
        <div class="store-links">
            <a id="woolworthsLink" href="#" target="_blank">Woolworths</a>
            <a id="paknsaveLink" href="#" target="_blank">Pak'nSave</a>
            <a id="newworldLink" href="#" target="_blank">New World</a>
        </div>
    </div>
</div>

<!-- NEW: All Foods Modal Structure -->
<div id="allFoodsModalBg" class="modal-bg">
    <div class="modal-content">
        <span class="modal-close" id="closeAllFoodsModal">&times;</span>
        <h2>All Available Foods</h2>
        <ul id="allFoodsList">
            <!-- Food items will be loaded here dynamically -->
        </ul>
    </div>
</div>

<!-- Changed script import to module type and assigned to window.foodsDatabase -->
<script type="module">
    import foodsDatabase from './foodDatabase.js';
    window.foodsDatabase = foodsDatabase;
</script>

<script defer>
    // === Storage keys ===
    const STORAGE_LOG_KEY = "dailyFoodLogWithPhotos";
    const STORAGE_SETTINGS_KEY = "foodTrackerSettings";

    // === Load persisted data ===
    let dailyLog = JSON.parse(localStorage.getItem(STORAGE_LOG_KEY)) || [];
    let settings = JSON.parse(localStorage.getItem(STORAGE_SETTINGS_KEY)) || {
        calorieGoal: 2500,
        unitPreference: "metric",
    };

    // === DOM elements ===
    const foodInput = document.getElementById("foodInput");
    const foodSuggestionsDiv = document.getElementById("foodSuggestions");
    const amountInput = document.getElementById("amountInput");
    const portionTypeSelect = document.getElementById("portionTypeSelect");
    const mealPhotoInput = document.getElementById("mealPhotoInput");
    const addMealBtn = document.getElementById("addMealBtn");

    const totalCaloriesSpan = document.getElementById("totalCalories");
    const totalProteinSpan = document.getElementById("totalProtein");
    const totalFatSpan = document.getElementById("totalFat");
    const totalCarbsSpan = document.getElementById("totalCarbs");
    const totalSugarSpan = document.getElementById("totalSugar");
    const totalSodiumSpan = document.getElementById("totalSodium");
    const totalBloatScaleSpan = document.getElementById("totalBloatScale");
    const calorieProgressBar = document.getElementById("calorieProgress");

    const mealHistoryDiv = document.getElementById("mealHistoryDiv");

    const openSettingsModalBtn = document.getElementById("openSettingsModalBtn");
    const settingsModalBg = document.getElementById("settingsModalBg");
    const closeSettingsModal = document.getElementById("closeSettingsModal");
    const calorieGoalInput = document.getElementById("calorieGoalInput");
    const unitPreferenceSelect = document.getElementById("unitPreferenceSelect");
    const saveSettingsBtn = document.getElementById("saveSettingsBtn");

    const imageModalBg = document.getElementById("imageModalBg");
    const modalImage = document.getElementById("modalImage");
    const closeImageModal = document.getElementById("closeImageModal");
    const darkModeToggle = document.getElementById('darkModeToggle');

    const foodInfoModalBg = document.getElementById("foodInfoModalBg");
    const closeFoodInfoModal = document.getElementById("closeFoodInfoModal");
    const foodInfoTitle = document.getElementById("foodInfoTitle");
    const infoCalories100g = document.getElementById("infoCalories100g");
    const infoProtein100g = document.getElementById("infoProtein100g");
    const infoFat100g = document.getElementById("infoFat100g");
    const infoCarbs100g = document.getElementById("infoCarbs100g");
    const infoSugar100g = document.getElementById("infoSugar100g");
    const infoSodium100g = document.getElementById("infoSodium100g");
    const infoBloatScale100g = document.getElementById("infoBloatScale100g");
    const infoServingSize = document.getElementById("infoServingSize");
    const infoCaloriesServing = document.getElementById("infoCaloriesServing");
    const infoProteinServing = document.getElementById("infoProteinServing");
    const infoFatServing = document.getElementById("infoFatServing");
    const infoCarbsServing = document.getElementById("infoCarbsServing");
    const infoSugarServing = document.getElementById("infoSugarServing");
    const infoSodiumServing = document.getElementById("infoSodiumServing");
    const woolworthsLink = document.getElementById("woolworthsLink");
    const paknsaveLink = document.getElementById("paknsaveLink");
    const newworldLink = document.getElementById("newworldLink");

    const resetHistoryBtn = document.getElementById("resetHistoryBtn");
    const showAllFoodsBtn = document.getElementById("showAllFoodsBtn"); 

    // Generic Alert Modal elements
    const alertModalBg = document.getElementById("alertModalBg");
    const alertModalTitle = document.getElementById("alertModalTitle");
    const alertModalMessage = document.getElementById("alertModalMessage");
    const alertModalOkBtn = document.getElementById("alertModalOkBtn");
    const closeAlertModal = document.getElementById("closeAlertModal");

    // Generic Confirm Modal elements
    const confirmModalBg = document.getElementById("confirmModalBg");
    const confirmModalTitle = document.getElementById("confirmModalTitle");
    const confirmModalMessage = document.getElementById("confirmModalMessage");
    const confirmModalOkBtn = document.getElementById("confirmModalOkBtn");
    const confirmModalCancelBtn = document.getElementById("confirmModalCancelBtn");
    const closeConfirmModal = document.getElementById("closeConfirmModal");

    // NEW: All Foods Modal elements
    const allFoodsModalBg = document.getElementById("allFoodsModalBg");
    const closeAllFoodsModal = document.getElementById("closeAllFoodsModal");
    const allFoodsList = document.getElementById("allFoodsList");


    let confirmCallback = null; // To store the callback for the confirm modal

    // === Autocomplete variables ===
    let currentSuggestions = [];
    let selectedSuggestionIndex = -1;

    // === Initialize dark mode ===
    function initDarkMode() {
        if (localStorage.getItem('darkMode') === 'enabled') {
            document.body.classList.add('dark-mode');
        }
    }

    // Toggle dark mode
    darkModeToggle.addEventListener('click', () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('darkMode', document.body.classList.contains('dark-mode') ? 'enabled' : 'disabled');
    });

    // === Helpers ===
    function fmt(n) {
        if (typeof n === 'number' && !isNaN(n)) {
            return n.toFixed(1);
        }
        return '0.0';
    }

    function normalizeName(name) {
        return name.trim().toLowerCase().replace(/\s+/g, '');
    }

    // === Unit conversion helpers ===
    function convertWeightToPreferredUnit(g) {
        if (settings.unitPreference === "imperial") {
            return (g / 28.3495).toFixed(1) + " oz";
        }
        return g.toFixed(1) + " g";
    }

    // === Save helpers ===
    function saveLog(log) {
        localStorage.setItem(STORAGE_LOG_KEY, JSON.stringify(log));
    }
    function saveSettings(settingsObj) {
        localStorage.setItem(STORAGE_SETTINGS_KEY, JSON.stringify(settingsObj));
    }

    // === Custom Alert and Confirm Modals ===
    function showAlert(title, message) {
        alertModalTitle.textContent = title;
        alertModalMessage.textContent = message;
        alertModalBg.classList.add('show');
    }

    alertModalOkBtn.addEventListener('click', () => {
        alertModalBg.classList.remove('show');
    });
    closeAlertModal.addEventListener('click', () => {
        alertModalBg.classList.remove('show');
    });
    alertModalBg.addEventListener('click', (e) => {
        if (e.target === alertModalBg) {
            alertModalBg.classList.remove('show');
        }
    });

    function showConfirm(title, message, onConfirmCallback) {
        confirmModalTitle.textContent = title;
        confirmModalMessage.textContent = message;
        confirmCallback = onConfirmCallback; // Store the callback
        confirmModalBg.classList.add('show');
    }

    confirmModalOkBtn.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback(true);
        }
        confirmModalBg.classList.remove('show');
    });
    confirmModalCancelBtn.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback(false);
        }
        confirmModalBg.classList.remove('show');
    });
    closeConfirmModal.addEventListener('click', () => {
        if (confirmCallback) {
            confirmCallback(false);
        }
        confirmModalBg.classList.remove('show');
    });
    confirmModalBg.addEventListener('click', (e) => {
        if (e.target === confirmModalBg) {
            if (confirmCallback) {
                confirmCallback(false);
            }
            confirmModalBg.classList.remove('show');
        }
    });

    // === Calculate macros based on amount and portion type ===
    function calculateMacros(foodData, amount, portionType) {
        let factor;
        let calculatedWeight;

        if (portionType === "grams") {
            factor = amount / 100;
            calculatedWeight = amount;
        } else if (portionType === "servings") {
            calculatedWeight = amount * (foodData.weightPerUnit || 100);
            factor = calculatedWeight / 100;
        } else {
            return null;
        }

        return {
            calories: (foodData.caloriesPer100g || 0) * factor,
            protein: (foodData.proteinPer100g || 0) * factor,
            fat: (foodData.fatPer100g || 0) * factor,
            carbs: (foodData.carbsPer100g || 0) * factor,
            sugar: (foodData.sugarPer100g || 0) * factor,
            sodium: (foodData.sodiumPer100g || 0) * factor,
            bloatScale: (foodData.bloatScale || 0),
            weight: calculatedWeight,
        };
    }

    // === Autocomplete Functions ===
    foodInput.addEventListener('input', showFoodSuggestions);
    foodInput.addEventListener('keydown', handleFoodInputKeydown);

    function showFoodSuggestions() {
        const inputVal = foodInput.value.trim();
        foodSuggestionsDiv.innerHTML = '';
        currentSuggestions = [];
        selectedSuggestionIndex = -1;

        if (inputVal.length === 0) {
            foodSuggestionsDiv.style.display = 'none';
            return;
        }

        // Access the global foodsDatabase object
        const foodNames = Object.keys(window.foodsDatabase);
        const normalizedInputVal = normalizeName(inputVal);

        const matchingFoods = foodNames.filter(name => name.startsWith(normalizedInputVal))
                                        .sort((a, b) => window.foodsDatabase[a].name.localeCompare(window.foodsDatabase[b].name));

        if (matchingFoods.length > 0) {
            matchingFoods.forEach(foodNormalizedName => {
                const suggestionItem = document.createElement('div');
                suggestionItem.classList.add('suggestion-item');
                suggestionItem.textContent = window.foodsDatabase[foodNormalizedName].name;
                suggestionItem.dataset.foodName = foodNormalizedName;

                suggestionItem.addEventListener('click', () => {
                    foodInput.value = suggestionItem.textContent;
                    foodInput.dataset.selectedNormalizedFood = suggestionItem.dataset.foodName;
                    foodSuggestionsDiv.style.display = 'none';
                });
                foodSuggestionsDiv.appendChild(suggestionItem);
                currentSuggestions.push(suggestionItem);
            });
            foodSuggestionsDiv.style.display = 'block';
        } else {
            foodSuggestionsDiv.style.display = 'none';
        }
    }


    function hideFoodSuggestions() {
        foodSuggestionsDiv.style.display = 'none';
        selectedSuggestionIndex = -1;
    }

    function handleFoodInputKeydown(e) {
        if (foodSuggestionsDiv.style.display === 'block' && currentSuggestions.length > 0) {
            if (selectedSuggestionIndex > -1) {
                currentSuggestions[selectedSuggestionIndex].classList.remove('selected');
            }

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedSuggestionIndex = (selectedSuggestionIndex + 1) % currentSuggestions.length;
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedSuggestionIndex = (selectedSuggestionIndex - 1 + currentSuggestions.length) % currentSuggestions.length;
            } else if (e.key === 'Enter') {
                e.preventDefault();
                if (selectedSuggestionIndex > -1) {
                    currentSuggestions[selectedSuggestionIndex].click();
                } else {
                    addMealBtn.click();
                }
                hideFoodSuggestions();
                return;
            } else if (e.key === 'Escape') {
                hideFoodSuggestions();
                return;
            }

            if (selectedSuggestionIndex > -1) {
                const selectedItem = currentSuggestions[selectedSuggestionIndex];
                selectedItem.classList.add('selected');
                selectedItem.scrollIntoView({ block: 'nearest' });
                foodInput.value = selectedItem.textContent;
                foodInput.dataset.selectedNormalizedFood = selectedItem.dataset.foodName;
            }
        } else if (e.key === 'Enter') {
            addMealBtn.click();
        }
    }


    document.addEventListener('click', (e) => {
        if (!foodInput.contains(e.target) && !foodSuggestionsDiv.contains(e.target)) {
            hideFoodSuggestions();
        }
    });

    // === Add meal to log ===
    addMealBtn.addEventListener("click", () => {
        const foodNameRaw = foodInput.value.trim();
        const normName = foodInput.dataset.selectedNormalizedFood || normalizeName(foodNameRaw);
        
        if (!foodNameRaw) {
            showAlert("Input Error", "Please enter a food name.");
            return;
        }
        // Use window.foodsDatabase here
        if (!(normName in window.foodsDatabase)) {
            showAlert("Food Not Found", `Food "${foodNameRaw}" not found in database. Try another or check spelling.`);
            return;
        }
        const amount = parseFloat(amountInput.value);
        if (isNaN(amount) || amount <= 0) {
            showAlert("Input Error", "Enter a valid positive amount.");
            return;
        }
        const portionType = portionTypeSelect.value;

        // Use window.foodsDatabase here
        const foodData = window.foodsDatabase[normName];
        const macros = calculateMacros(foodData, amount, portionType);
        if (!macros) {
            showAlert("Calculation Error", "Error calculating macros.");
            return;
        }

        const newMeal = {
            name: foodNameRaw,
            normalizedName: normName,
            calories: macros.calories,
            protein: macros.protein,
            fat: macros.fat,
            carbs: macros.carbs,
            sugar: macros.sugar,
            sodium: macros.sodium,
            bloatScale: macros.bloatScale,
            weight: macros.weight,
            timestamp: Date.now(),
            photo: null,
        };

        const file = mealPhotoInput.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function (e) {
                newMeal.photo = e.target.result;
                dailyLog.push(newMeal);
                saveLog(dailyLog);
                renderMealHistory();
                updateTotalsAndProgress();
                resetInputs();
            };
            reader.readAsDataURL(file);
        } else {
            dailyLog.push(newMeal);
            saveLog(dailyLog);
            renderMealHistory();
            updateTotalsAndProgress();
            resetInputs();
        }
    });

    // === Reset input fields ===
    function resetInputs() {
        foodInput.value = "";
        amountInput.value = "";
        mealPhotoInput.value = "";
        foodInput.dataset.selectedNormalizedFood = "";
        hideFoodSuggestions();
    }

    // === Render meal log ===
    function renderMealHistory() {
        mealHistoryDiv.innerHTML = "";
        if (dailyLog.length === 0) {
            mealHistoryDiv.innerHTML = '<div class="empty-state">No meals logged yet.</div>';
            return;
        }

        const mealLogContainer = document.createElement('div');
        mealLogContainer.classList.add('meal-log-container');
        const mealLogGrid = document.createElement('div');
        mealLogGrid.classList.add('meal-log-grid');

        // Create header row - UPDATED HEADERS
        const header = document.createElement('div');
        header.classList.add('meal-log-header');
        const headers = ["Food", "Calories", "Protein(g)", "Fat(g)", "Carbs(g)", "Sugar(g)", "Sodium(mg)", "Bloat", ""];
        headers.forEach(text => {
            const cell = document.createElement('div');
            cell.classList.add('grid-cell');
            cell.textContent = text;
            header.appendChild(cell);
        });
        mealLogGrid.appendChild(header);

        // Render each meal item
        dailyLog.forEach((meal, i) => {
            const div = document.createElement("div");
            div.classList.add("list-item");

            // Food Name Cell - Now contains name and Info button stacked
            const foodNameCell = document.createElement('div');
            foodNameCell.classList.add('grid-cell', 'food-name');
            const foodNameSpan = document.createElement('span');
            foodNameSpan.textContent = meal.name;
            foodNameCell.appendChild(foodNameSpan);

            const infoBtn = document.createElement("button");
            infoBtn.textContent = "Info";
            infoBtn.classList.add("btn-info");
            infoBtn.title = `Show info for ${meal.name}`;
            infoBtn.addEventListener("click", () => {
                showFoodInfoModal(meal.normalizedName);
            });
            foodNameCell.appendChild(infoBtn);

            // NEW: Show Image Button
            if (meal.photo) {
                const showImageBtn = document.createElement("button");
                showImageBtn.textContent = "Show";
                showImageBtn.classList.add("btn-info", "btn-show-image");
                showImageBtn.title = `Show photo for ${meal.name}`;
                showImageBtn.addEventListener("click", () => {
                    modalImage.src = meal.photo;
                    imageModalBg.classList.add("show");
                });
                foodNameCell.appendChild(showImageBtn);
            }

            div.appendChild(foodNameCell);


            const kcalCell = document.createElement('div');
            kcalCell.classList.add('grid-cell');
            kcalCell.textContent = fmt(meal.calories);
            div.appendChild(kcalCell);

            const proteinCell = document.createElement('div');
            proteinCell.classList.add('grid-cell');
            proteinCell.textContent = fmt(meal.protein);
            div.appendChild(proteinCell);

            const fatCell = document.createElement('div');
            fatCell.classList.add('grid-cell');
            fatCell.textContent = fmt(meal.fat);
            div.appendChild(fatCell);

            const carbsCell = document.createElement('div');
            carbsCell.classList.add('grid-cell');
            carbsCell.textContent = fmt(meal.carbs);
            div.appendChild(carbsCell);

            const sugarCell = document.createElement('div');
            sugarCell.classList.add('grid-cell');
            sugarCell.textContent = fmt(meal.sugar);
            div.appendChild(sugarCell);

            const sodiumCell = document.createElement('div');
            sodiumCell.classList.add('grid-cell');
            sodiumCell.textContent = fmt(meal.sodium);
            div.appendChild(sodiumCell);

            const bloatCell = document.createElement('div');
            bloatCell.classList.add('grid-cell');
            bloatCell.textContent = `${meal.bloatScale}/10`;
            div.appendChild(bloatCell);

            const actionsCell = document.createElement('div');
            actionsCell.classList.add('grid-cell', 'actions');
            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "X";
            deleteBtn.classList.add("btn-danger");
            deleteBtn.title = `Delete ${meal.name}`;
            deleteBtn.addEventListener("click", () => {
                dailyLog.splice(i, 1);
                saveLog(dailyLog);
                renderMealHistory();
                updateTotalsAndProgress();
            });
            actionsCell.appendChild(deleteBtn);
            div.appendChild(actionsCell);

            mealLogGrid.appendChild(div);
        });
        mealHistoryDiv.appendChild(mealLogContainer);
        mealLogContainer.appendChild(mealLogGrid);
    }

    // === Update totals and progress bar ===
    function updateTotalsAndProgress() {
        const totals = dailyLog.reduce((acc, meal) => {
            acc.calories += meal.calories;
            acc.protein += meal.protein;
            acc.fat += meal.fat;
            acc.carbs += meal.carbs;
            acc.sugar += meal.sugar;
            acc.sodium += meal.sodium;
            acc.bloatScale += meal.bloatScale;
            return acc;
        }, { calories: 0, protein: 0, fat: 0, carbs: 0, sugar: 0, sodium: 0, bloatScale: 0 });

        totalCaloriesSpan.textContent = fmt(totals.calories);
        totalProteinSpan.textContent = fmt(totals.protein);
        totalFatSpan.textContent = fmt(totals.fat);
        totalCarbsSpan.textContent = fmt(totals.carbs);
        totalSugarSpan.textContent = fmt(totals.sugar);
        totalSodiumSpan.textContent = fmt(totals.sodium);
        totalBloatScaleSpan.textContent = fmt(totals.bloatScale);

        const caloriePercentage = (totals.calories / settings.calorieGoal) * 100;
        calorieProgressBar.style.width = `${Math.min(caloriePercentage, 100)}%`;
        calorieProgressBar.style.backgroundColor = caloriePercentage > 100 ? 'var(--danger-color)' : 'var(--success-color)';
    }

    // === Modals functionality ===
    openSettingsModalBtn.addEventListener("click", () => {
        calorieGoalInput.value = settings.calorieGoal;
        unitPreferenceSelect.value = settings.unitPreference;
        settingsModalBg.classList.add("show");
    });

    closeSettingsModal.addEventListener("click", () => {
        settingsModalBg.classList.remove("show");
    });

    settingsModalBg.addEventListener("click", (e) => {
        if (e.target === settingsModalBg) {
            settingsModalBg.classList.remove("show");
        }
    });

    saveSettingsBtn.addEventListener("click", () => {
        const newGoal = parseInt(calorieGoalInput.value);
        if (!isNaN(newGoal) && newGoal > 0) {
            settings.calorieGoal = newGoal;
        } else {
            showAlert("Input Error", "Please enter a valid calorie goal.");
            return;
        }
        settings.unitPreference = unitPreferenceSelect.value;
        saveSettings(settings);
        updateTotalsAndProgress();
        settingsModalBg.classList.remove("show");
    });

    // Close image modal
    closeImageModal.addEventListener("click", () => {
        imageModalBg.classList.remove("show");
        modalImage.src = "";
    });

    imageModalBg.addEventListener("click", (e) => {
        if (e.target === imageModalBg) {
            imageModalBg.classList.remove("show");
            modalImage.src = "";
        }
    });

    // Food Info Modal
    function showFoodInfoModal(normalizedFoodName) {
        // Use window.foodsDatabase here
        const food = window.foodsDatabase[normalizedFoodName];
        if (!food) {
            showAlert("Error", "Food details not found.");
            return;
        }

        foodInfoTitle.textContent = food.name;
        infoCalories100g.textContent = fmt(food.caloriesPer100g);
        infoProtein100g.textContent = fmt(food.proteinPer100g);
        infoFat100g.textContent = fmt(food.fatPer100g);
        infoCarbs100g.textContent = fmt(food.carbsPer100g);
        infoSugar100g.textContent = fmt(food.sugarPer100g);
        infoSodium100g.textContent = fmt(food.sodiumPer100g);
        infoBloatScale100g.textContent = food.bloatScale;

        const servingSize = food.weightPerUnit || 100;
        const servingFactor = servingSize / 100;

        infoServingSize.textContent = convertWeightToPreferredUnit(servingSize);
        infoCaloriesServing.textContent = fmt(food.caloriesPer100g * servingFactor);
        infoProteinServing.textContent = fmt(food.proteinPer100g * servingFactor);
        infoFatServing.textContent = fmt(food.fatPer100g * servingFactor);
        infoCarbsServing.textContent = fmt(food.carbsPer100g * servingFactor);
        infoSugarServing.textContent = fmt(food.sugarPer100g * servingFactor);
        infoSodiumServing.textContent = fmt(food.sodiumPer100g * servingFactor);

        const searchQuery = encodeURIComponent(food.name);
        woolworthsLink.href = `https://www.woolworths.co.nz/shop/search/products?searchTerm=${searchQuery}`;
        paknsaveLink.href = `https://www.paknsave.co.nz/shop/legacy/products?q=${searchQuery}`;
        newworldLink.href = `https://www.newworld.co.nz/shop/legacy/products?q=${searchQuery}`;


        foodInfoModalBg.classList.add("show");
    }

    closeFoodInfoModal.addEventListener("click", () => {
        foodInfoModalBg.classList.remove("show");
    });

    foodInfoModalBg.addEventListener("click", (e) => {
        if (e.target === foodInfoModalBg) {
            foodInfoModalBg.classList.remove("show");
        }
    });

    // NEW: Reset History Functionality
    resetHistoryBtn.addEventListener("click", () => {
        showConfirm(
            "Reset History",
            "Are you sure you want to reset all your meal history and settings? This cannot be undone.",
            (confirmed) => {
                if (confirmed) {
                    dailyLog = [];
                    settings = {
                        calorieGoal: 2500,
                        unitPreference: "metric",
                    };
                    saveLog(dailyLog);
                    saveSettings(settings);
                    renderMealHistory();
                    updateTotalsAndProgress();
                    showAlert("Reset Complete", "All history and settings have been reset.");
                }
            }
        );
    });

    // NEW: Show All Foods button functionality (UPDATED)
    showAllFoodsBtn.addEventListener("click", () => {
        renderAllFoods();
        allFoodsModalBg.classList.add("show");
    });

    // NEW: Function to render all foods into the new modal
    function renderAllFoods() {
        allFoodsList.innerHTML = ''; // Clear previous list
        // Ensure window.foodsDatabase is defined before accessing its keys
        const foodNames = window.foodsDatabase ? Object.keys(window.foodsDatabase).sort((a, b) => window.foodsDatabase[a].name.localeCompare(window.foodsDatabase[b].name)) : [];

        if (foodNames.length === 0) {
            allFoodsList.innerHTML = '<li>No foods found in database.</li>';
            return;
        }

        foodNames.forEach(normalizedName => {
            const food = window.foodsDatabase[normalizedName];
            const listItem = document.createElement('li');
            listItem.textContent = food.name;
            listItem.dataset.normalizedName = normalizedName; // Store normalized name for lookup
            listItem.addEventListener('click', () => {
                foodInput.value = food.name;
                foodInput.dataset.selectedNormalizedFood = normalizedName;
                allFoodsModalBg.classList.remove('show'); // Close the all foods modal
                hideFoodSuggestions(); // Hide any existing suggestions
                // Optional: focus on amount input or add meal button
                amountInput.focus();
            });
            allFoodsList.appendChild(listItem);
        });
    }

    // NEW: Close All Foods Modal
    closeAllFoodsModal.addEventListener("click", () => {
        allFoodsModalBg.classList.remove("show");
    });

    allFoodsModalBg.addEventListener("click", (e) => {
        if (e.target === allFoodsModalBg) {
            allFoodsModalBg.classList.remove("show");
        }
    });


    // === Initial load ===
    initDarkMode();
    renderMealHistory();
    updateTotalsAndProgress();
</script>
</body>
</html>
